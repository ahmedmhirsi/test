{% extends 'back_office/base.html.twig' %}

{% block title %}Ticket #{{ reclamation.id }} - Support Command{% endblock %}

{% block header_title %}
    <span class="flex items-center gap-2">
        <span class="material-symbols-outlined text-nexus-primary animate-pulse-slow">support_agent</span>
        Support Command
    </span>
{% endblock %}

{% block content %}
<div class="swup-transition-fade pb-20 max-w-5xl mx-auto">

    {# â”€â”€â”€ Top Navigation & Actions â”€â”€â”€ #}
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 animate-slide-up">
        <div class="flex items-center gap-4">
            <a href="{{ path('back_reclamation_index') }}" class="size-10 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/10 transition-all group">
                <span class="material-symbols-outlined group-hover:-translate-x-1 transition-transform">arrow_back</span>
            </a>
            <div>
                <h1 class="text-2xl font-black text-white tracking-tight">Ticket <span class="text-nexus-primary">#{{ reclamation.id }}</span></h1>
                <p class="text-xs text-gray-500 uppercase tracking-widest font-bold">{{ reclamation.dateCreation|date('d M Y \Ã  H:i') }}</p>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <a href="{{ path('back_reclamation_export_pdf', {id: reclamation.id}) }}" target="_blank" class="px-4 py-2 rounded-xl border border-rose-500/20 bg-rose-500/10 text-rose-400 hover:bg-rose-500/20 transition-all text-xs font-bold flex items-center gap-2">
                <span class="material-symbols-outlined text-[18px]">picture_as_pdf</span>
                Export PDF
            </a>
            <a href="{{ path('back_reclamation_edit', {id: reclamation.id}) }}" class="px-4 py-2 rounded-xl border border-white/10 bg-white/5 text-gray-300 hover:text-white hover:bg-white/10 transition-all text-xs font-bold flex items-center gap-2">
                <span class="material-symbols-outlined text-[18px]">edit</span>
                Modifier
            </a>
            <form method="post" action="{{ path('back_reclamation_delete', {id: reclamation.id}) }}" onsubmit="return confirm('Supprimer dÃ©finitivement ce ticket ?');" class="inline">
                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ reclamation.id) }}">
                <button type="submit" class="px-4 py-2 rounded-xl border border-red-500/20 bg-red-500/10 text-red-400 hover:bg-red-500/20 transition-all text-xs font-bold flex items-center gap-2">
                    <span class="material-symbols-outlined text-[18px]">delete</span>
                    Supprimer
                </button>
            </form>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {# â”€â”€â”€ Left Column: Ticket Details â”€â”€â”€ #}
        <div class="lg:col-span-2 space-y-8">
            
            {# Description Card #}
            <div class="glass-panel p-8 animate-slide-up" style="animation-delay: 0.1s">
                <div class="flex justify-between items-start mb-6">
                    <div class="flex items-center gap-3">
                        <div class="size-12 rounded-2xl bg-nexus-primary/10 border border-nexus-primary/20 flex items-center justify-center">
                            <span class="material-symbols-outlined text-nexus-primary text-2xl">description</span>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-white">{{ reclamation.titre }}</h2>
                            <p class="text-xs text-gray-500">{{ reclamation.email }}</p>
                        </div>
                    </div>
                    
                    {% if reclamation.statut == 'en_cours' %}
                        <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-amber-500/10 text-amber-500 border border-amber-500/20">En cours</span>
                    {% elseif reclamation.statut == 'repondu' %}
                        <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-emerald-500/10 text-emerald-500 border border-emerald-500/20">RÃ©pondu</span>
                    {% else %}
                        <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-gray-500/10 text-gray-400 border border-gray-500/20">FermÃ©</span>
                    {% endif %}
                </div>

                <div class="prose prose-invert max-w-none">
                    <p class="text-[#D3C3B9]/80 leading-relaxed whitespace-pre-wrap">{{ reclamation.description }}</p>
                </div>

                {% if reclamation.pieceJointe %}
                    <div class="mt-8 pt-6 border-t border-white/5">
                        <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-3">PiÃ¨ce Jointe</p>
                        <a href="{{ asset('uploads/reclamations/' ~ reclamation.pieceJointe) }}" target="_blank" class="inline-flex items-center gap-3 p-3 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 transition-all group">
                            <span class="material-symbols-outlined text-nexus-primary">attach_file</span>
                            <span class="text-sm font-bold text-white">Visualiser le document</span>
                            <span class="material-symbols-outlined text-gray-500 text-sm group-hover:translate-x-1 transition-transform">open_in_new</span>
                        </a>
                    </div>
                {% endif %}

                {# Translation Toggle #}
                <div class="mt-8 pt-6 border-t border-white/5" x-data="{ showTranslation: false }">
                    <button @click="showTranslation = !showTranslation" class="flex items-center gap-2 text-xs font-bold text-nexus-stone hover:text-white transition-colors uppercase tracking-widest">
                        <span class="material-symbols-outlined text-[18px]">translate</span>
                        Intelligent Translation
                        <span class="material-symbols-outlined text-[16px] transition-transform" :class="showTranslation ? 'rotate-180' : ''">expand_more</span>
                    </button>

                    <div x-show="showTranslation" x-collapse x-cloak class="mt-6 space-y-4">
                        <div class="flex flex-wrap items-center gap-4">
                            <select id="targetLanguage" class="nexus-input py-2 px-4 !bg-nexus-dark/50 !w-48 text-xs">
                                <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
                                <option value="en">ðŸ‡¬ðŸ‡§ English</option>
                                <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
                                <option value="ar">ðŸ‡¸ðŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                                <option value="de">ðŸ‡©ðŸ‡ª Deutsch</option>
                            </select>
                            <button id="doTranslate" class="btn-nexus-primary py-2 px-6 rounded-xl text-[10px] uppercase font-black tracking-widest">
                                Traduire
                            </button>
                            <div id="translationLoader" class="hidden flex items-center gap-2 text-xs text-nexus-stone animate-pulse">
                                <span class="material-symbols-outlined animate-spin text-[16px]">progress_activity</span>
                                AI Analysis...
                            </div>
                        </div>

                        <div id="translationResult" class="hidden p-6 rounded-2xl bg-emerald-500/5 border border-emerald-500/10">
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-[10px] font-black text-emerald-500 uppercase tracking-widest flex items-center gap-2">
                                    <span class="material-symbols-outlined text-[16px]">auto_awesome</span>
                                    AI Translation
                                </span>
                                <span id="detectedLanguage" class="text-[10px] text-emerald-500/60 uppercase font-bold"></span>
                            </div>
                            <h4 id="translatedTitle" class="text-white font-bold mb-2"></h4>
                            <p id="translatedDescription" class="text-sm text-[#D3C3B9]/70 whitespace-pre-wrap"></p>
                        </div>
                    </div>
                </div>
            </div>

            {# Responses Thread #}
            <div class="space-y-6 animate-slide-up" style="animation-delay: 0.2s">
                <div class="flex items-center justify-between px-2">
                    <h3 class="text-sm font-black text-white uppercase tracking-widest flex items-center gap-3">
                        <span class="material-symbols-outlined text-nexus-primary text-[20px]">reply_all</span>
                        Communication Thread
                    </h3>
                    <span class="px-2 py-0.5 rounded bg-white/5 text-[10px] text-gray-500 font-bold">{{ reclamation.reponses|length }} Messages</span>
                </div>

                <div class="space-y-6">
                    {% for reponse in reclamation.reponses %}
                        <div class="flex gap-4 {{ reponse.auteurType == 'admin' ? 'flex-row-reverse' : '' }}">
                            <div class="size-10 rounded-xl flex items-center justify-center shrink-0 shadow-lg {{ reponse.auteurType == 'admin' ? 'bg-nexus-primary text-white shadow-nexus-primary/20' : 'bg-white/5 text-gray-400 border border-white/10' }}">
                                <span class="material-symbols-outlined text-[20px]">{{ reponse.auteurType == 'admin' ? 'support_agent' : 'person' }}</span>
                            </div>
                            
                            <div class="flex-1 max-w-[85%] {{ reponse.auteurType == 'admin' ? 'text-right' : '' }}">
                                <div class="glass-panel !p-5 {{ reponse.auteurType == 'admin' ? '!bg-nexus-primary/10 border-nexus-primary/20 rounded-tr-none' : 'border-white/5 rounded-tl-none' }}">
                                    <div class="flex items-center gap-2 mb-2 {{ reponse.auteurType == 'admin' ? 'flex-row-reverse' : '' }}">
                                        <span class="text-xs font-black text-white">{{ reponse.auteur }}</span>
                                        <span class="text-[10px] font-black uppercase px-1.5 py-0.5 rounded {{ reponse.auteurType == 'admin' ? 'bg-nexus-primary/20 text-nexus-primary' : 'bg-white/5 text-gray-500' }}">
                                            {{ reponse.auteurType == 'admin' ? 'Staff' : 'Client' }}
                                        </span>
                                        <span class="text-[10px] text-gray-500 font-medium {{ reponse.auteurType == 'admin' ? 'mr-auto' : 'ml-auto' }}">
                                            {{ reponse.dateReponse|date('H:i') }}
                                        </span>
                                        
                                        {% if reponse.auteurType == 'admin' %}
                                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <a href="{{ path('back_reponse_edit', {id: reponse.id}) }}" class="text-gray-500 hover:text-white"><span class="material-symbols-outlined text-[14px]">edit</span></a>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <p class="text-sm text-[#D3C3B9]/90 whitespace-pre-wrap">{{ reponse.message }}</p>
                                    
                                    {% if reponse.pieceJointe %}
                                        <div class="mt-4 pt-3 border-t border-white/5 flex {{ reponse.auteurType == 'admin' ? 'justify-end' : '' }}">
                                            <a href="{{ asset('uploads/reclamations/' ~ reponse.pieceJointe) }}" target="_blank" class="flex items-center gap-2 text-[10px] font-bold text-nexus-primary hover:text-white transition-colors">
                                                <span class="material-symbols-outlined text-[14px]">attach_file</span>
                                                {{ reponse.pieceJointe|slice(0, 20) }}...
                                            </a>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-12 glass-panel opacity-50">
                            <span class="material-symbols-outlined text-4xl text-gray-600 mb-2">forum</span>
                            <p class="text-xs uppercase tracking-widest font-black text-gray-500">Waiting for first response</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        {# â”€â”€â”€ Right Column: Reply Form â”€â”€â”€ #}
        <div class="lg:col-span-1">
            <div class="sticky top-24 space-y-6 animate-slide-up" style="animation-delay: 0.3s">
                <div class="glass-panel !p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="size-8 rounded-lg bg-emerald-500/10 flex items-center justify-center">
                            <span class="material-symbols-outlined text-emerald-400 text-[18px]">send</span>
                        </div>
                        <h3 class="text-sm font-black text-white uppercase tracking-widest">Post Reply</h3>
                    </div>

                    {{ form_start(reponse_form, {'attr': {'class': 'space-y-4'}}) }}
                        <div>
                            {{ form_widget(reponse_form.auteur, {'attr': {'class': 'nexus-input text-xs', 'placeholder': 'Auteur...'}}) }}
                        </div>
                        <div>
                            {{ form_widget(reponse_form.message, {'attr': {'class': 'nexus-input min-h-[160px] text-sm py-4', 'placeholder': 'Type your response...'}}) }}
                        </div>
                        <div class="relative group">
                            <div class="absolute inset-y-0 left-4 flex items-center pointer-events-none">
                                <span class="material-symbols-outlined text-gray-500 group-hover:text-nexus-primary transition-colors">attach_file</span>
                            </div>
                            {{ form_widget(reponse_form.pieceJointe, {'attr': {'class': 'nexus-input !pl-12 text-[10px]'}}) }}
                        </div>

                        <button type="submit" class="w-full btn-nexus-primary py-4 rounded-xl flex items-center justify-center gap-3 group relative overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
                            <span class="material-symbols-outlined text-[20px]">send</span>
                            <span class="font-black uppercase tracking-widest text-xs">Send Message</span>
                        </button>
                    {{ form_end(reponse_form) }}
                </div>

                <div class="glass-panel !p-6 border-nexus-primary/10">
                    <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-4">Quick Insights</p>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-400">Response SLA</span>
                            <span class="text-emerald-400 font-bold">Within 2h</span>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-400">Priority</span>
                            <span class="text-amber-400 font-bold">Executive</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const doTranslateBtn = document.getElementById('doTranslate');
            const targetLanguageSelect = document.getElementById('targetLanguage');
            const translationResult = document.getElementById('translationResult');
            const translationLoader = document.getElementById('translationLoader');
            
            doTranslateBtn?.addEventListener('click', async function() {
                const targetLanguage = targetLanguageSelect.value;
                const reclamationId = {{ reclamation.id }};
                
                translationResult.classList.add('hidden');
                translationLoader.classList.remove('hidden');
                doTranslateBtn.disabled = true;
                
                try {
                    const response = await fetch(`/back/reclamation/${reclamationId}/translate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ language: targetLanguage })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        document.getElementById('translatedTitle').textContent = data.title;
                        document.getElementById('translatedDescription').textContent = data.description;
                        document.getElementById('detectedLanguage').textContent = data.detectedLanguage ? `Detected: ${data.detectedLanguage}` : '';
                        translationResult.classList.remove('hidden');
                        gsap.from("#translationResult", { y: 10, opacity: 0, duration: 0.4 });
                    }
                } catch (error) {
                    console.error('Translation error:', error);
                } finally {
                    translationLoader.classList.add('hidden');
                    doTranslateBtn.disabled = false;
                }
            });

            // Entry animations
            gsap.from(".animate-slide-up", {
                y: 30,
                opacity: 0,
                duration: 0.8,
                stagger: 0.15,
                ease: "power2.out"
            });
        });
    </script>
{% endblock %}
