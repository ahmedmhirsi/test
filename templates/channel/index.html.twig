{% extends is_granted('ROLE_ADMIN') ? 'back_office/base.html.twig' : 'layout/employe.html.twig' %}

{% block title %}Channels - Nexus AI{% endblock %}

{% block header_title %}
    <span class="flex items-center gap-2">
        <span class="material-symbols-outlined text-nexus-primary animate-spin-slow">forum</span>
        Channels
    </span>
{% endblock %}

{% block content %}
<div class="swup-transition-fade pb-20">

    {# ─── Header & Controls ─── #}
    <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
        <div>
            <h1 class="text-3xl md:text-4xl font-black text-white tracking-tight mb-2">Communication Channels</h1>
            <p class="text-gray-400 text-sm">Discussions, Vocaux et Collaboration en temps réel.</p>
        </div>
        
        <div class="flex flex-wrap gap-3">
            {# Search Bar #}
            <form method="get" class="relative group">
                <input type="text" name="q" value="{{ searchTerm }}" placeholder="Rechercher..." 
                       class="pl-10 pr-4 py-2.5 bg-white/5 border border-white/10 rounded-full text-sm text-white focus:bg-nexus-navy focus:border-nexus-primary focus:ring-1 focus:ring-nexus-primary transition-all w-64 group-hover:w-72">
                <span class="absolute left-3 top-2.5 material-symbols-outlined text-gray-500 text-[18px]">search</span>
            </form>

            <a href="{{ path('app_channel_new') }}" class="btn-nexus-primary rounded-full px-5 py-2.5 flex items-center gap-2 shadow-lg shadow-nexus-primary/30 group">
                <span class="material-symbols-outlined text-[18px] group-hover:rotate-90 transition-transform">add</span>
                <span class="font-bold text-sm">Nouveau</span>
            </a>
             <a href="{{ path('app_channel_export_pdf') }}" class="size-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-red-400 hover:bg-red-500/10 hover:border-red-500/30 transition-all" title="Export PDF">
                <span class="material-symbols-outlined text-[20px]">picture_as_pdf</span>
            </a>
        </div>
    </div>

    {# ─── Channels Grid (Floating Glass Cards) ─── #}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        
        {% for channel in channels %}
            <div class="glass-panel p-6 antigravity-shadow group relative overflow-visible hover:-translate-y-2 transition-transform duration-500">
                
                 {# Hover Glow #}
                <div class="absolute inset-0 bg-gradient-to-br from-nexus-primary/0 to-nexus-accent/0 group-hover:from-nexus-primary/10 group-hover:to-nexus-accent/10 rounded-3xl transition-all duration-500"></div>

                {# Header: Icon & Status #}
                <div class="flex justify-between items-start mb-6 relative z-10">
                    <div class="size-14 rounded-2xl flex items-center justify-center border border-white/10 shadow-inner
                        {% if channel.type == 'Vocal' %}
                            bg-orange-500/10 text-orange-400 group-hover:bg-orange-500/20 group-hover:scale-110 transition-all
                        {% else %}
                            bg-blue-500/10 text-blue-400 group-hover:bg-blue-500/20 group-hover:scale-110 transition-all
                        {% endif %}">
                        <span class="material-symbols-outlined text-3xl">{% if channel.type == 'Vocal' %}mic{% else %}chat{% endif %}</span>
                    </div>
                    
                    <span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-wider border border-white/5
                        {% if channel.statut == 'Actif' %}bg-green-500/10 text-green-400{% else %}bg-gray-500/10 text-gray-400{% endif %}">
                        {{ channel.statut }}
                    </span>
                </div>

                {# Content #}
                <div class="relative z-10 mb-6">
                    <h3 class="text-xl font-bold text-white mb-2 group-hover:text-transparent group-hover:bg-clip-text group-hover:bg-gradient-to-r group-hover:from-white group-hover:to-gray-400 transition-all">
                        {{ channel.nom }}
                    </h3>
                    <p class="text-sm text-gray-400 line-clamp-2 h-10">{{ channel.description }}</p>
                </div>

                {# Stats & Footer #}
                <div class="flex items-center justify-between pt-4 border-t border-white/5 relative z-10">
                    <div class="flex items-center gap-4 text-xs font-medium text-gray-500">
                         <span class="flex items-center gap-1 group-hover:text-nexus-primary transition-colors">
                            <span class="material-symbols-outlined text-[14px]">group</span> {{ channel.participantCount }}
                        </span>
                        <span class="flex items-center gap-1 group-hover:text-nexus-accent transition-colors">
                            <span class="material-symbols-outlined text-[14px]">chat</span> {{ channel.messageCount }}
                        </span>
                    </div>

                    <a href="{{ path('app_channel_show', {'id': channel.id}) }}" class="size-8 rounded-full bg-white/5 flex items-center justify-center text-gray-400 hover:bg-nexus-primary hover:text-white transition-all hover:scale-110">
                        <span class="material-symbols-outlined text-[16px]">arrow_forward</span>
                    </a>
                </div>

                 {# Background Decor #}
                <div class="absolute -right-10 -bottom-10 size-32 rounded-full blur-[60px] opacity-0 group-hover:opacity-100 transition-opacity duration-700
                    {% if channel.type == 'Vocal' %}bg-orange-500/20{% else %}bg-blue-500/20{% endif %}"></div>
            </div>
        {% else %}
             <div class="col-span-full flex flex-col items-center justify-center p-16 glass-panel text-center">
                <div class="size-20 rounded-full bg-white/5 flex items-center justify-center mb-4">
                    <span class="material-symbols-outlined text-4xl text-gray-600">forum</span>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Aucun Channel Trouvé</h3>
                <p class="text-gray-400 max-w-md mx-auto mb-6">Commencez par créer un nouveau canal de discussion pour votre équipe.</p>
                <a href="{{ path('app_channel_new') }}" class="btn-nexus-primary rounded-full px-6 py-3">
                    Créer le premier Channel
                </a>
            </div>
        {% endfor %}
    </div>

    {# ─── Admin Table View (Optional Toggle could go here) ─── #}
    {% if is_granted('ROLE_ADMIN') and channels|length > 0 %}
        <div class="mt-16">
            <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
                <span class="material-symbols-outlined text-nexus-accent">admin_panel_settings</span>
                Vue Administrateur
            </h3>
            <div class="glass-panel p-0 overflow-hidden antigravity-shadow">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-white/5 text-xs font-bold text-gray-400 uppercase tracking-wider">
                            <tr>
                                <th class="p-4">Channel</th>
                                <th class="p-4">Type</th>
                                <th class="p-4">Stats</th>
                                <th class="p-4">Statut</th>
                                <th class="p-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5 text-sm text-gray-300">
                             {% for channel in channels %}
                                <tr class="hover:bg-white/5 transition-colors group">
                                    <td class="p-4 font-bold text-white">{{ channel.nom }}</td>
                                    <td class="p-4">
                                        <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase border border-white/10
                                            {% if channel.type == 'Vocal' %}bg-orange-500/10 text-orange-400{% else %}bg-blue-500/10 text-blue-400{% endif %}">
                                            {{ channel.type }}
                                        </span>
                                    </td>
                                    <td class="p-4 text-gray-500">{{ channel.participantCount }} membres</td>
                                    <td class="p-4">
                                         <span class="flex items-center gap-1.5 text-xs font-bold {% if channel.statut == 'Actif' %}text-green-400{% else %}text-gray-400{% endif %}">
                                            <span class="size-1.5 rounded-full {% if channel.statut == 'Actif' %}bg-green-500 animate-pulse{% else %}bg-gray-500{% endif %}"></span>
                                            {{ channel.statut }}
                                        </span>
                                    </td>
                                    <td class="p-4 text-right">
                                        <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <a href="{{ path('app_channel_edit', {'id': channel.id}) }}" class="size-8 rounded-lg bg-white/5 flex items-center justify-center hover:bg-white/10 text-gray-400 hover:text-white transition-colors">
                                                <span class="material-symbols-outlined text-[16px]">edit</span>
                                            </a>
                                             <form method="post" action="{{ path('app_channel_delete', {'id': channel.id}) }}" onsubmit="return confirm('Supprimer ?');">
                                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ channel.id) }}">
                                                <button class="size-8 rounded-lg bg-red-500/10 flex items-center justify-center hover:bg-red-500/20 text-red-400 transition-colors">
                                                    <span class="material-symbols-outlined text-[16px]">delete</span>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                             {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}

</div>
{% endblock %}
