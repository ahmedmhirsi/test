{% extends 'back_office/base.html.twig' %}
{% import '_components.html.twig' as ui %}

{% block title %}Milestone: {{ jalon.titre }} – Portfolio Roadmap{% endblock %}

{% block header_title %}
    <span class="flex items-center gap-2">
        <span class="material-symbols-outlined text-nexus-primary">flag</span>
        Strategic Milestone Overview
    </span>
{% endblock %}

{% block content %}
<div class="swup-transition-fade pb-20">

    {# ─── Breadcrumb ─── #}
    <nav class="flex items-center gap-2 text-[11px] font-bold uppercase tracking-wider text-slate-500 mb-8 animate-card">
        <a href="{{ path('app_jalon_index') }}" class="hover:text-nexus-primary transition-colors">Milestones</a>
        <span class="material-symbols-outlined text-[16px]">chevron_right</span>
        <span class="text-white">{{ jalon.titre }}</span>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {# ─── Left: Achievement Core ─── #}
        <div class="lg:col-span-2 space-y-8 animate-card" style="animation-delay: 0.1s">
            
            {# Jalon Header Card #}
            <div class="glass-panel p-8 group">
                <div class="flex flex-col md:flex-row justify-between items-start gap-6 relative z-10">
                    <div class="flex items-start gap-5">
                        {% set isAtteint = jalon.statut == 'atteint' %}
                        <div class="size-16 rounded-2xl bg-slate-900 border border-white/5 flex items-center justify-center relative shadow-xl">
                             <span class="material-symbols-outlined text-[32px] {{ isAtteint ? 'text-emerald-400' : 'text-nexus-primary' }}">
                                {{ isAtteint ? 'verified' : 'flag' }}
                             </span>
                        </div>
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <h1 class="text-4xl font-extrabold text-white tracking-tight">{{ jalon.titre }}</h1>
                                {{ ui.status_badge(jalon.statut) }}
                            </div>
                            <p class="text-slate-400 text-sm font-medium leading-relaxed max-w-lg">{{ jalon.description }}</p>
                        </div>
                    </div>
                </div>

                <div class="mt-8 grid grid-cols-2 gap-4 relative z-10">
                    <div class="bg-slate-950/30 p-5 rounded-2xl border border-white/5">
                        <p class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-1">Impact Portfolio</p>
                        <p class="text-lg font-bold text-white">{{ jalon.projet ? jalon.projet.titre : 'Global Initiative' }}</p>
                    </div>
                    <div class="bg-slate-950/30 p-5 rounded-2xl border border-white/5">
                        <p class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-1">Maturity Date</p>
                        <p class="text-lg font-bold {{ jalon.isOverdue() ? 'text-rose-500' : 'text-white' }}">
                            {{ jalon.dateEcheance|date('d M Y') }}
                        </p>
                    </div>
                </div>
            </div>

            {# Verification & Tasks linked #}
            <div class="glass-panel p-8">
                <div class="flex items-center justify-between mb-8">
                     <h3 class="text-[11px] font-bold text-white uppercase tracking-widest flex items-center gap-3">
                        <span class="size-2 rounded-full bg-nexus-primary"></span>
                        Validation Protocol ({{ jalon.completedTasksCount }}/3)
                    </h3>
                    <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Minimum Threshold: 3 Units</span>
                </div>

                {# Progress Bar #}
                <div class="mb-10 p-6 rounded-2xl bg-slate-950/30 border border-white/5">
                    <div class="flex justify-between items-end mb-3">
                         <p class="text-[11px] font-bold text-slate-500 uppercase tracking-wider">Achievement Ratio</p>
                         <p class="text-2xl font-black text-white">{{ jalon.progressPercentage }}%</p>
                    </div>
                    <div class="h-2 w-full bg-slate-800 rounded-full overflow-hidden">
                        <div class="h-full bg-nexus-primary transition-all duration-1000" style="width: {{ jalon.progressPercentage }}%"></div>
                    </div>
                    {% if jalon.isValidated %}
                        <p class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest mt-4 flex items-center gap-2">
                            <span class="material-symbols-outlined text-[16px]">verified</span>
                            Threshold Reached — Operational Milestone Validated
                        </p>
                    {% endif %}
                </div>

                {# Tasks Grid #}
                <div class="space-y-3">
                    {% for tache in jalon.taches %}
                         <div class="group flex items-center gap-4 p-4 rounded-xl bg-white/[0.02] border border-white/5 hover:border-nexus-primary/20 transition-all">
                             <div class="size-10 rounded-lg flex items-center justify-center {{ tache.isCompleted ? 'bg-emerald-500/10 text-emerald-400' : 'bg-slate-800 text-slate-500' }}">
                                 <span class="material-symbols-outlined text-[20px]">
                                    {{ tache.isCompleted ? 'check_circle' : 'pending' }}
                                 </span>
                             </div>
                             <div class="flex-1">
                                 <a href="{{ path('app_tache_show', {id: tache.id}) }}" class="text-sm font-bold text-white group-hover:text-nexus-primary transition-colors {{ tache.isCompleted ? 'line-through opacity-50' : '' }}">
                                     {{ tache.titre }}
                                 </a>
                                 <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-0.5">{{ tache.sprint ? tache.sprint.nom : 'Standalone Operation' }}</p>
                             </div>
                             <div class="text-[10px] font-bold">
                                {{ ui.status_badge(tache.statut) }}
                             </div>
                         </div>
                    {% else %}
                        <div class="py-12 text-center text-slate-600 bg-slate-950/30 rounded-2xl border border-dashed border-white/10">
                            <span class="material-symbols-outlined text-[40px] opacity-20 mb-2">link_off</span>
                            <p class="text-xs font-bold uppercase">No associated operations found.</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        {# ─── Right: Intel & Meta ─── #}
        <div class="space-y-6 animate-card" style="animation-delay: 0.2s">
            
            {# Timeline countdown #}
            <div class="glass-panel p-6">
                <h3 class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-6">Time to Maturity</h3>
                {% set daysRemaining = jalon.getDaysRemaining() %}
                <div class="flex flex-col items-center py-4">
                     <div class="text-5xl font-black mb-1 {{ jalon.isOverdue() ? 'text-rose-500' : (isAtteint ? 'text-emerald-400' : 'text-white') }}">
                        {{ daysRemaining|abs }}
                     </div>
                     <p class="text-[10px] font-bold text-slate-600 uppercase tracking-widest">Days Balance</p>
                </div>
                <div class="mt-6 pt-6 border-t border-white/5">
                     <div class="flex justify-between items-center text-[11px] font-bold uppercase mb-4">
                        <span class="text-slate-500">Criticality</span>
                        {{ ui.priority_badge(jalon.priorite) }}
                    </div>
                </div>
            </div>

            {# Quick Control #}
            <div class="glass-panel p-6 space-y-3">
                 <h3 class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-4">Command Center</h3>
                 {% if can_edit_jalon %}
                 <a href="{{ path('app_jalon_edit', {id: jalon.id}) }}" class="w-full btn-nexus-primary py-3 rounded-xl flex items-center justify-center gap-2 text-xs">
                    <span class="material-symbols-outlined text-[18px]">tune</span>
                    Update Objective
                </a>
                {% endif %}
                <a href="{{ path('app_jalon_index') }}" class="w-full flex items-center justify-center gap-2 py-3 text-xs font-bold text-slate-500 hover:text-white transition-colors">
                    <span class="material-symbols-outlined text-[18px]">arrow_back</span>
                    Back to Roadmap
                </a>
            </div>

            {# IA Advice card #}
            <div class="glass-panel p-6 bg-slate-900/50">
                 <div class="flex gap-4">
                    <div class="size-8 rounded-lg bg-nexus-primary/10 flex items-center justify-center text-nexus-primary shrink-0 border border-nexus-primary/20">
                        <span class="material-symbols-outlined text-[18px]">analytics</span>
                    </div>
                    <div>
                        <h4 class="text-[11px] font-bold text-white uppercase tracking-widest mb-2">Predictive Analysis</h4>
                        <p class="text-[11px] text-slate-500 leading-relaxed font-medium">
                            {% if jalon.isValidated %}
                                Objective secured. Resource reallocation to next roadmap item recommended.
                            {% else %}
                                Priority check: Focus on high-velocity tasks to reach the 3-unit validation threshold.
                            {% endif %}
                        </p>
                    </div>
                 </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
