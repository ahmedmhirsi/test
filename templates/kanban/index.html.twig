{% extends 'back_office/base.html.twig' %}

{% block title %}Kanban Command - Nexus AI{% endblock %}

{% block header_title %}
    <span class="flex items-center gap-2">
        <span class="material-symbols-outlined text-nexus-primary animate-spin-slow">view_kanban</span>
        Kanban Command
    </span>
{% endblock %}

{% block head %}
<style>
    .kanban-column {
        min-height: 600px;
        transition: all 0.3s ease;
    }
    .task-card {
        cursor: grab;
        transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .task-card:active {
        cursor: grabbing;
        transform: scale(1.02);
    }
    .task-card.dragging {
        opacity: 0.5;
        transform: rotate(2deg) scale(0.95);
        filter: grayscale(100%);
    }
    .kanban-column.drag-over {
        background: rgba(255, 255, 255, 0.05);
        box-shadow: inset 0 0 20px rgba(99, 102, 241, 0.2);
        border-color: rgba(99, 102, 241, 0.4);
    }
    /* Custom Scrollbar for columns */
    .kanban-column::-webkit-scrollbar {
        width: 4px;
    }
    .kanban-column::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="swup-transition-fade h-[calc(100vh-140px)] flex flex-col">

    {# â”€â”€â”€ Header & Controls â”€â”€â”€ #}
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 shrink-0">
        <div>
            <h1 class="text-2xl font-black text-white tracking-tight flex items-center gap-2">
                <span class="material-symbols-outlined text-nexus-primary">dns</span> 
                Tableau OpÃ©rationnel
            </h1>
        </div>

        <div class="flex items-center gap-4">
             <div class="glass-panel px-3 py-1.5 rounded-full flex items-center gap-2 border border-white/10">
                <span class="text-xs font-bold text-gray-400 uppercase">Sprint:</span>
                <select id="sprint-selector" onchange="window.location.href='{{ path('app_kanban_index') }}?sprint=' + this.value"
                        class="bg-transparent border-none text-white text-sm font-bold focus:ring-0 cursor-pointer py-0 pl-0 pr-8">
                    {% for s in sprints %}
                        <option value="{{ s.id }}" {{ sprint and sprint.id == s.id ? 'selected' : 'class="text-gray-900"' }}>
                            {{ s.nom }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            {% if can_create_sprint %}
                 <a href="{{ path('app_sprint_new') }}" class="size-9 rounded-full bg-nexus-primary/20 hover:bg-nexus-primary text-nexus-primary hover:text-white flex items-center justify-center transition-all">
                    <span class="material-symbols-outlined text-[20px]">add</span>
                </a>
            {% endif %}
        </div>
    </div>

    {% if sprint %}
        {# â”€â”€â”€ Board â”€â”€â”€ #}
        <div class="flex gap-4 overflow-x-auto pb-4 flex-1 h-full items-stretch">
            
            {# TO DO Column #}
            <div class="w-80 shrink-0 flex flex-col">
                <div class="flex items-center justify-between mb-3 px-1">
                    <h3 class="font-bold text-gray-400 text-sm uppercase tracking-widest flex items-center gap-2">
                        <span class="size-2 rounded-full bg-gray-500"></span> Ã€ Faire
                    </h3>
                    <span class="bg-white/10 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">{{ tasks.todo|length }}</span>
                </div>
                <div class="kanban-column glass-panel p-3 border border-white/5 bg-black/20 flex-1 rounded-2xl overflow-y-auto space-y-3"
                     data-status="todo"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <div class="space-y-3" id="column-todo">
                        {% for task in tasks.todo %}
                            {{ include('kanban/_task_card.html.twig', {task: task}) }}
                        {% endfor %}
                    </div>
                </div>
            </div>

            {# IN PROGRESS Column #}
            <div class="w-80 shrink-0 flex flex-col">
                <div class="flex items-center justify-between mb-3 px-1">
                    <h3 class="font-bold text-nexus-primary text-sm uppercase tracking-widest flex items-center gap-2">
                        <span class="size-2 rounded-full bg-nexus-primary animate-pulse"></span> En Cours
                    </h3>
                    <span class="bg-nexus-primary/20 text-nexus-primary text-[10px] font-bold px-2 py-0.5 rounded-full border border-nexus-primary/20">{{ tasks.in_progress|length }}</span>
                </div>
                <div class="kanban-column glass-panel p-3 border border-nexus-primary/10 bg-nexus-primary/5 flex-1 rounded-2xl overflow-y-auto space-y-3"
                     data-status="in_progress"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <div class="space-y-3" id="column-in_progress">
                        {% for task in tasks.in_progress %}
                            {{ include('kanban/_task_card.html.twig', {task: task}) }}
                        {% endfor %}
                    </div>
                </div>
            </div>

            {# REVIEW Column #}
            <div class="w-80 shrink-0 flex flex-col">
                <div class="flex items-center justify-between mb-3 px-1">
                     <h3 class="font-bold text-nexus-secondary text-sm uppercase tracking-widest flex items-center gap-2">
                        <span class="size-2 rounded-full bg-nexus-secondary"></span> Review
                    </h3>
                    <span class="bg-nexus-secondary/20 text-nexus-secondary text-[10px] font-bold px-2 py-0.5 rounded-full border border-nexus-secondary/20">{{ tasks.review|length }}</span>
                </div>
                <div class="kanban-column glass-panel p-3 border border-white/5 bg-black/20 flex-1 rounded-2xl overflow-y-auto space-y-3"
                     data-status="review"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <div class="space-y-3" id="column-review">
                         {% for task in tasks.review %}
                            {{ include('kanban/_task_card.html.twig', {task: task}) }}
                        {% endfor %}
                    </div>
                </div>
            </div>

            {# DONE Column #}
            <div class="w-80 shrink-0 flex flex-col">
                  <div class="flex items-center justify-between mb-3 px-1">
                     <h3 class="font-bold text-green-400 text-sm uppercase tracking-widest flex items-center gap-2">
                        <span class="size-2 rounded-full bg-green-500"></span> TerminÃ©
                    </h3>
                    <span class="bg-green-500/20 text-green-400 text-[10px] font-bold px-2 py-0.5 rounded-full border border-green-500/20">{{ tasks.done|length }}</span>
                </div>
                <div class="kanban-column glass-panel p-3 border border-green-500/10 bg-green-500/5 flex-1 rounded-2xl overflow-y-auto space-y-3"
                     data-status="done"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                     <div class="space-y-3" id="column-done">
                        {% for task in tasks.done %}
                            {{ include('kanban/_task_card.html.twig', {task: task}) }}
                        {% endfor %}
                    </div>
                </div>
            </div>

        </div>
    {% else %}
        <div class="flex-1 flex flex-col items-center justify-center text-center">
             <div class="size-24 rounded-full bg-white/5 flex items-center justify-center mb-6 animate-pulse-slow">
                <span class="material-symbols-outlined text-5xl text-gray-600">view_kanban</span>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">SystÃ¨me en attente</h2>
            <p class="text-gray-400 max-w-md mx-auto mb-8">Veuillez sÃ©lectionner ou crÃ©er un sprint pour activer le tableau de commande.</p>
             {% if can_create_sprint %}
            <a href="{{ path('app_sprint_new') }}" class="btn-nexus-primary rounded-full px-8 py-3 shadow-lg shadow-nexus-primary/30">
                Initialiser Sprint
            </a>
            {% endif %}
        </div>
    {% endif %}

</div>

{# Quick Log Modal (Glass Style) #}
<div id="quick-log-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[100]">
    <div class="glass-panel p-8 w-full max-w-md mx-4 antigravity-shadow relative transform transition-all scale-100">
        <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
            <span class="material-symbols-outlined text-nexus-accent">timer</span> Enregistrer Temps
        </h3>
        <form id="quick-log-form">
            <input type="hidden" id="ql-task-id">
            <div class="mb-5">
                <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">DurÃ©e (minutes)</label>
                <input type="number" id="ql-duree" min="1" required
                       class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:border-nexus-primary focus:ring-1 focus:ring-nexus-primary transition-all">
            </div>
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Notes</label>
                <textarea id="ql-notes" rows="3"
                          class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:border-nexus-primary focus:ring-1 focus:ring-nexus-primary transition-all"></textarea>
            </div>
            <div class="flex gap-4">
                <button type="button" onclick="closeQuickLogModal()"
                        class="flex-1 px-4 py-3 rounded-xl font-bold text-gray-400 hover:text-white hover:bg-white/10 transition-colors">
                    Annuler
                </button>
                <button type="submit"
                        class="flex-1 btn-nexus-primary rounded-xl py-3 font-bold shadow-lg shadow-nexus-primary/20">
                    Confirmer
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let draggedTask = null;

function handleDragStart(e) {
    draggedTask = e.target;
    // visual feedback
    setTimeout(() => e.target.classList.add('dragging'), 0);
    
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
    document.querySelectorAll('.kanban-column').forEach(col => {
        col.classList.remove('drag-over');
    });
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

async function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    
    const taskId = e.dataTransfer.getData('text/plain');
    const newStatus = e.currentTarget.dataset.status;
    const column = e.currentTarget.querySelector('[id^="column-"]');
    
    if (draggedTask && column) {
        column.appendChild(draggedTask);
        
        // Visual pop effect on drop
        draggedTask.style.transform = 'scale(1.05)';
        setTimeout(() => draggedTask.style.transform = '', 200);

        // Logic remains same...
        const tasks = column.querySelectorAll('.task-card');
        let order = 0;
        tasks.forEach((task, index) => {
            if (task.dataset.taskId === taskId) {
                order = index;
            }
        });
        
        try {
            const response = await fetch('{{ path('app_kanban_update_status') }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ taskId: parseInt(taskId), status: newStatus, order: order })
            });
            const data = await response.json();
            if (data.milestoneUpdate && data.milestoneUpdate.isValidated) {
                // TODO: Replace with custom toast
                alert('ðŸŽ‰ Jalon "' + data.milestoneUpdate.titre + '" validÃ©!'); 
            }
        } catch (error) {
            console.error('Error updating task:', error);
        }
    }
}

function openQuickLogModal(taskId) {
    document.getElementById('ql-task-id').value = taskId;
    document.getElementById('ql-duree').value = '';
    document.getElementById('ql-notes').value = '';
    const modal = document.getElementById('quick-log-modal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function closeQuickLogModal() {
    const modal = document.getElementById('quick-log-modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

// Form submit handler remains same...
</script>
{% endblock %}
