{% extends 'back_office/base.html.twig' %}

{% block title %}Analytics - Marketing Command{% endblock %}

{% block header_title %}
    <span class="flex items-center gap-2">
        <span class="material-symbols-outlined text-nexus-primary animate-pulse-slow">insights</span>
        Marketing Intelligence
    </span>
{% endblock %}

{% block content %}
<div class="swup-transition-fade pb-20">

    {# ─── Header ─── #}
    <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
        <div>
             <h1 class="text-4xl font-black text-white tracking-tight leading-tight animate-slide-up">
                Performance <span class="text-transparent bg-clip-text bg-gradient-to-r from-nexus-primary to-purple-400">Analytics</span>
            </h1>
            <p class="text-gray-400 text-sm mt-2 animate-slide-up" style="animation-delay: 0.1s">
                Analyse d'impact en temps réel et ROI.
            </p>
        </div>
        
        <div class="flex gap-3 animate-slide-up" style="animation-delay: 0.2s">
            <button class="glass-panel px-4 py-2 flex items-center gap-2 rounded-full hover:bg-white/10 transition-colors group">
                 <span class="material-symbols-outlined text-gray-400 group-hover:text-white">calendar_today</span>
                 <span class="text-xs font-bold text-gray-300 group-hover:text-white uppercase tracking-wider">30 Jours</span>
            </button>
             <button class="btn-nexus-primary rounded-full px-6 py-2 flex items-center gap-2 shadow-lg shadow-nexus-primary/30 group">
                <span class="material-symbols-outlined text-lg group-hover:animate-bounce">download</span>
                <span>Export Report</span>
            </button>
        </div>
    </div>

    {# ─── KPI Grid ─── #}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 animate-slide-up" style="animation-delay: 0.3s">
        
        {# Avg CAC #}
        <div class="glass-panel p-6 relative overflow-hidden group">
            <div class="absolute -right-6 -top-6 w-24 h-24 bg-nexus-primary/20 rounded-full blur-xl group-hover:scale-150 transition-transform duration-500"></div>
            <div class="flex justify-between items-start mb-4">
                <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Coût Acquisition (CAC)</p>
                <div class="p-2 rounded-lg bg-nexus-primary/10 text-nexus-primary">
                    <span class="material-symbols-outlined text-[20px]">trending_up</span>
                </div>
            </div>
            <div class="flex items-end gap-1 mb-2">
                <span class="text-3xl font-black text-white">{{ performanceMetrics.avgCac|number_format(0) }}</span>
                <span class="text-xs font-bold text-gray-500 mb-1">TND</span>
            </div>
            <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-[10px] font-bold text-emerald-400 uppercase tracking-wider">
                <span class="material-symbols-outlined text-[12px]">rocket_launch</span>
                {{ performanceMetrics.avgRoi|number_format(1) }}x ROI
            </div>
        </div>

        {# Total Leards #}
        <div class="glass-panel p-6 relative overflow-hidden group">
             <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-500/10 rounded-full blur-xl group-hover:scale-150 transition-transform duration-500"></div>
            <div class="flex justify-between items-start mb-4">
                <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Total Leads</p>
                <div class="p-2 rounded-lg bg-blue-500/10 text-blue-400">
                    <span class="material-symbols-outlined text-[20px]">groups</span>
                </div>
            </div>
            <div class="flex items-end gap-1">
                <span class="text-3xl font-black text-white">{{ performanceMetrics.totalLeads }}</span>
            </div>
             <p class="text-xs text-gray-500 mt-2">Clients potentiels</p>
        </div>

        {# Conversion Rate #}
         <div class="glass-panel p-6 relative overflow-hidden group">
             <div class="absolute -right-6 -top-6 w-24 h-24 bg-purple-500/10 rounded-full blur-xl group-hover:scale-150 transition-transform duration-500"></div>
            <div class="flex justify-between items-start mb-4">
                <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Conversion</p>
                <div class="p-2 rounded-lg bg-purple-500/10 text-purple-400">
                    <span class="material-symbols-outlined text-[20px]">filter_alt</span>
                </div>
            </div>
             {% set conversionRate = performanceMetrics.totalLeads > 0 ? (performanceMetrics.totalConverted / performanceMetrics.totalLeads) * 100 : 0 %}
            <div class="flex items-end gap-1 mb-2">
                <span class="text-3xl font-black text-white">{{ conversionRate|number_format(1) }}</span>
                <span class="text-lg font-bold text-gray-500 mb-1">%</span>
            </div>
             <p class="text-xs text-gray-500">{{ performanceMetrics.totalConverted }} contrats signés</p>
        </div>

        {# Total Spent #}
        <div class="glass-panel p-6 relative overflow-hidden group">
             <div class="absolute -right-6 -top-6 w-24 h-24 bg-red-500/10 rounded-full blur-xl group-hover:scale-150 transition-transform duration-500"></div>
            <div class="flex justify-between items-start mb-4">
                <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Budget Utilisé</p>
                <div class="p-2 rounded-lg bg-red-500/10 text-red-400">
                    <span class="material-symbols-outlined text-[20px]">account_balance_wallet</span>
                </div>
            </div>
            <div class="flex items-end gap-1">
                <span class="text-3xl font-black text-white">{{ performanceMetrics.totalSpent|number_format(0) }}</span>
                <span class="text-xs font-bold text-gray-500 mb-1">TND</span>
            </div>
             <p class="text-xs text-gray-500 mt-2">Global campagnes</p>
        </div>
    </div>

    {# ─── Charts Section ─── #}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 animate-slide-up" style="animation-delay: 0.4s">
        
        {# Trend Chart #}
        <div class="md:col-span-2 glass-panel p-6">
            <h3 class="text-sm font-bold text-white mb-6 uppercase tracking-wider flex items-center gap-2">
                <span class="size-2 rounded-full bg-nexus-primary animate-pulse"></span>
                Tendance Acquisition
            </h3>
            <div class="h-64 relative">
                <canvas id="leadTrendChart"></canvas>
            </div>
        </div>

        {# Budget Chart #}
        <div class="glass-panel p-6 flex flex-col">
             <h3 class="text-sm font-bold text-white mb-6 uppercase tracking-wider">Répartition Budget</h3>
            <div class="h-48 relative flex-1">
                <canvas id="budgetChart"></canvas>
                 <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                    <span class="text-2xl font-black text-white">{{ budgetStats.totalPlanned|number_format(0, '.', 'k') }}</span>
                    <span class="text-[10px] uppercase text-gray-500 font-bold tracking-widest">Total</span>
                </div>
            </div>
             <div class="mt-6 space-y-3">
                <div class="flex justify-between items-center text-xs">
                    <span class="flex items-center gap-2 text-gray-400"><span class="w-2 h-2 rounded-full bg-nexus-primary"></span> Dépensé</span>
                    <span class="font-bold text-white">{{ budgetStats.totalActual|number_format(0) }} TND</span>
                </div>
                <div class="flex justify-between items-center text-xs">
                    <span class="flex items-center gap-2 text-gray-400"><span class="w-2 h-2 rounded-full bg-gray-700"></span> Restant</span>
                    <span class="font-bold text-gray-400">{{ (budgetStats.totalPlanned - budgetStats.totalActual)|number_format(0) }} TND</span>
                </div>
            </div>
        </div>
    </div>

    {# ─── Bottom Section ─── #}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 animate-slide-up" style="animation-delay: 0.5s">
        
        {# Channel Performance #}
        <div class="glass-panel p-6">
            <h3 class="text-sm font-bold text-white mb-6 uppercase tracking-wider">Performance par Canal</h3>
            <div class="h-64">
                <canvas id="channelChart"></canvas>
            </div>
        </div>

        {# Funnel #}
        <div class="glass-panel p-6">
            <h3 class="text-sm font-bold text-white mb-6 uppercase tracking-wider">Entonnoir de Conversion</h3>
            <div class="space-y-6">
                {# New #}
                <div class="relative group">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest pl-2">Nouveaux Leads</span>
                        <span class="text-xs font-bold text-white bg-white/5 px-2 py-1 rounded">{{ leadStats.new|default(0) }}</span>
                    </div>
                     {% set totalLeads = leadStats.total|default(0) %}
                     {% set newPct = totalLeads > 0 ? (leadStats.new|default(0) / totalLeads) * 100 : 0 %}
                    <div class="h-2 bg-white/5 rounded-full overflow-hidden">
                        <div class="h-full bg-blue-500 rounded-full group-hover:shadow-[0_0_10px_rgba(59,130,246,0.5)] transition-all duration-500" style="width: {{ newPct }}%"></div>
                    </div>
                </div>

                {# Qualified #}
                 <div class="relative group">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest pl-2">Qualifiés</span>
                        <span class="text-xs font-bold text-white bg-white/5 px-2 py-1 rounded">{{ leadStats.qualified|default(0) }}</span>
                    </div>
                     {% set qualifiedPct = totalLeads > 0 ? (leadStats.qualified|default(0) / totalLeads) * 100 : 0 %}
                    <div class="h-2 bg-white/5 rounded-full overflow-hidden">
                        <div class="h-full bg-purple-500 rounded-full group-hover:shadow-[0_0_10px_rgba(168,85,247,0.5)] transition-all duration-500" style="width: {{ qualifiedPct }}%"></div>
                    </div>
                </div>

                {# Converted #}
                 <div class="relative group">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest pl-2">Convertis</span>
                        <span class="text-xs font-bold text-white bg-white/5 px-2 py-1 rounded">{{ leadStats.converted|default(0) }}</span>
                    </div>
                     {% set convertedPct = totalLeads > 0 ? (leadStats.converted|default(0) / totalLeads) * 100 : 0 %}
                    <div class="h-2 bg-white/5 rounded-full overflow-hidden">
                        <div class="h-full bg-emerald-500 rounded-full group-hover:shadow-[0_0_10px_rgba(16,185,129,0.5)] transition-all duration-500" style="width: {{ convertedPct }}%"></div>
                    </div>
                </div>
            </div>

             <div class="mt-8 p-4 rounded-xl bg-gradient-to-br from-nexus-primary/10 to-purple-500/10 border border-white/5 flex gap-4 items-start">
                  <span class="material-symbols-outlined text-nexus-accent mt-0.5 animate-pulse">auto_awesome</span>
                  <div>
                      <h4 class="text-sm font-bold text-white">Insight IA</h4>
                      <p class="text-xs text-gray-400 mt-1 leading-relaxed">
                          Taux de conversion global de <strong class="text-white">{{ conversionRate|number_format(1) }}%</strong>.
                          {% if conversionRate < 5 %}
                              Optimisez le ciblage pour améliorer la qualité des leads.
                          {% elseif conversionRate > 20 %}
                              Excellent performance ! Pensez à augmenter le budget.
                          {% else %}
                              Performance stable. Concentrez-vous sur le nurturing.
                          {% endif %}
                      </p>
                  </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof Chart === 'undefined') return;

        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#9ca3af';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.05)';
        
        // --- Lead Trend Chart ---
        const trendCanvas = document.getElementById('leadTrendChart');
        if (trendCanvas) {
            const trendCtx = trendCanvas.getContext('2d');
            const trendGradient = trendCtx.createLinearGradient(0, 0, 0, 300);
            trendGradient.addColorStop(0, 'rgba(99, 102, 241, 0.2)'); // Nexus Primary
            trendGradient.addColorStop(1, 'rgba(99, 102, 241, 0)');

            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: {{ leadTrends|keys|json_encode|raw }},
                    datasets: [{
                        label: 'Nouveaux Leads',
                        data: {{ leadTrends|json_encode|raw }},
                        borderColor: '#6366f1',
                        backgroundColor: trendGradient,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#000',
                        pointBorderColor: '#6366f1',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            padding: 10,
                            displayColors: false,
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { precision: 0, font: { size: 10 } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 10 } }
                        }
                    }
                }
            });
        }

        // --- Budget Doughnut Chart ---
        const budgetCanvas = document.getElementById('budgetChart');
        if (budgetCanvas) {
            const budgetCtx = budgetCanvas.getContext('2d');
            new Chart(budgetCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Dépensé', 'Restant'],
                    datasets: [{
                        data: [
                            {{ budgetStats.totalActual }},
                            {{ budgetStats.totalPlanned - budgetStats.totalActual }}
                        ],
                        backgroundColor: ['#6366f1', '#334155'], // Nexus Primary & Slate 700
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // --- Channel Bar Chart ---
        const channelCanvas = document.getElementById('channelChart');
        if (channelCanvas) {
            const channelCtx = channelCanvas.getContext('2d');
            new Chart(channelCtx, {
                type: 'bar',
                data: {
                    labels: [{% for item in performanceByChannel %}"{{ item.channelName }}",{% endfor %}],
                    datasets: [{
                        label: 'Leads',
                        data: [{% for item in performanceByChannel %}{{ item.leads }},{% endfor %}],
                        backgroundColor: '#3b82f6', // Blue 500
                        borderRadius: 4,
                        maxBarThickness: 30
                    }, {
                        label: 'Convertis',
                        data: [{% for item in performanceByChannel %}{{ item.converted }},{% endfor %}],
                        backgroundColor: '#fbbf24', // Amber 400
                        borderRadius: 4,
                        maxBarThickness: 30
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom', 
                            labels: { usePointStyle: true, boxWidth: 6, font: { size: 10 }, color: '#9ca3af' } 
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { precision: 0 }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}
