{% extends 'marketing/base.html.twig' %}

{% block title %}Analytics{% endblock %}

{% block body %}
<div class="page-shell fade-in">
    <!-- Header -->
    <div class="page-header">
        <div>
            <h1 class="text-2xl font-display font-black text-navy dark:text-white tracking-tight">Marketing Analytics</h1>
            <p class="subtle text-sm mt-1">Performance insights & ROI tracking</p>
        </div>
    </div>

    <!-- Main KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- CAC Score -->
        <div class="md:col-span-1 bg-gold rounded-xl p-5 text-navy shadow-lg relative overflow-hidden group card-hover rise-in stagger-1">
            <div class="absolute -right-6 -top-6 w-24 h-24 bg-white/20 rounded-full group-hover:scale-150 transition-transform duration-500"></div>
            <div class="relative z-10 flex flex-col h-full justify-between">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-black uppercase tracking-widest opacity-80">CAC</p>
                        <h3 class="text-3xl font-black mt-1">{{ performanceMetrics.avgCac|number_format(2) }} <span class="text-sm">TND</span></h3>
                    </div>
                    <span class="material-symbols-outlined text-3xl opacity-50">trending_up</span>
                </div>
                <div class="mt-4 pt-4 border-t border-navy/10 flex justify-between items-center text-xs font-bold">
                    <span>Acquisition Cost</span>
                    <span class="bg-navy/10 px-2 py-0.5 rounded text-navy">{{ performanceMetrics.avgRoi|number_format(1) }}x ROI</span>
                </div>
            </div>
        </div>

        <!-- Total Spent -->
        <div class="kpi-card card-hover rise-in stagger-2">
            <div class="flex items-center gap-3 mb-2">
                <div class="p-2 bg-red-50 dark:bg-red-900/20 rounded-lg text-red-600">
                    <span class="material-symbols-outlined">account_balance_wallet</span>
                </div>
                <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Total Spent</p>
            </div>
            <div>
                <h3 class="text-2xl font-black text-navy dark:text-white">{{ performanceMetrics.totalSpent|number_format(0) }} <span class="text-sm text-gray-400">TND</span></h3>
                <p class="text-xs text-gray-500 mt-1">Across all campaigns</p>
            </div>
        </div>

        <!-- Total Leads -->
        <div class="kpi-card card-hover rise-in stagger-3">
            <div class="flex items-center gap-3 mb-2">
                <div class="p-2 bg-primary/10 dark:bg-primary/20 rounded-lg text-primary">
                    <span class="material-symbols-outlined">groups</span>
                </div>
                <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Total Leads</p>
            </div>
            <div>
                <h3 class="text-2xl font-black text-navy dark:text-white">{{ performanceMetrics.totalLeads }}</h3>
                <p class="text-xs text-gray-500 mt-1">Potential customers</p>
            </div>
        </div>

        <!-- Conversion Rate -->
        <div class="kpi-card card-hover rise-in stagger-4">
            <div class="flex items-center gap-3 mb-2">
                <div class="p-2 bg-green-50 dark:bg-green-900/20 rounded-lg text-green-600">
                    <span class="material-symbols-outlined">conversion_path</span>
                </div>
                <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Conversion</p>
            </div>
            <div>
                {% set conversionRate = performanceMetrics.totalLeads > 0 ? (performanceMetrics.totalConverted / performanceMetrics.totalLeads) * 100 : 0 %}
                <h3 class="text-2xl font-black text-navy dark:text-white">{{ conversionRate|number_format(1) }}%</h3>
                <p class="text-xs text-gray-500 mt-1">{{ performanceMetrics.totalConverted }} won deals</p>
            </div>
        </div>
    </div>

    <!-- Charts Row 1: Trends & Distribution -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Lead Trend Line Chart -->
        <div class="md:col-span-2 section-card p-6 rise-in">
            <h3 class="section-title mb-4">Lead Acquisition Trend (30 Days)</h3>
            <div class="h-64">
                <canvas id="leadTrendChart"></canvas>
            </div>
        </div>

        <!-- Budget Doughnut Chart -->
        <div class="section-card p-6 rise-in">
            <h3 class="section-title mb-4">Budget Distribution</h3>
            <div class="h-48 relative">
                <canvas id="budgetChart"></canvas>
                <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                    <span class="text-2xl font-black text-navy dark:text-white">{{ budgetStats.totalPlanned|number_format(0, '.', 'k') }}</span>
                    <span class="text-[10px] uppercase text-gray-400 font-bold">Total</span>
                </div>
            </div>
            <div class="mt-6 space-y-2">
                <div class="flex justify-between text-xs">
                    <span class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-primary"></span> Spent</span>
                    <span class="font-bold text-navy dark:text-white">{{ budgetStats.totalActual|number_format(0) }} TND</span>
                </div>
                <div class="flex justify-between text-xs">
                    <span class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-gray-200"></span> Remaining</span>
                    <span class="font-bold text-navy dark:text-white">{{ (budgetStats.totalPlanned - budgetStats.totalActual)|number_format(0) }} TND</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2: Channel Performance & Funnel -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Channel Bar Chart -->
        <div class="section-card p-6 rise-in">
            <h3 class="section-title mb-6">Channel Performance</h3>
            <div class="h-64">
                <canvas id="channelChart"></canvas>
            </div>
        </div>

        <!-- Lead Funnel -->
        <div class="section-card p-6 rise-in">
            <h3 class="section-title mb-4">Lead Funnel</h3>
            <div class="space-y-6 pt-4">
                <div class="relative">
                    <div class="flex items-center gap-4 mb-2">
                        <div class="w-24 text-right">
                            <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">New</span>
                        </div>
                        <div class="flex-1">
                            {% set totalLeads = leadStats.total|default(0) %}
                            {% set newPct = totalLeads > 0 ? (leadStats.new|default(0) / totalLeads) * 100 : 0 %}
                            <div class="h-2 bg-gray-100 dark:bg-[#0f1223] rounded-full overflow-hidden">
                                <div class="h-full bg-blue-500 rounded-full" style="width: {{ newPct }}%"></div>
                            </div>
                        </div>
                        <span class="text-sm font-bold text-navy dark:text-white w-8">{{ leadStats.new|default(0) }}</span>
                    </div>
                </div>

                <div class="relative">
                    <div class="flex items-center gap-4 mb-2">
                        <div class="w-24 text-right">
                            <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Qualified</span>
                        </div>
                        {% set qualifiedPct = totalLeads > 0 ? (leadStats.qualified|default(0) / totalLeads) * 100 : 0 %}
                        <div class="flex-1">
                            <div class="h-2 bg-gray-100 dark:bg-[#0f1223] rounded-full overflow-hidden">
                                <div class="h-full bg-purple-500 rounded-full" style="width: {{ qualifiedPct }}%"></div>
                            </div>
                        </div>
                         <span class="text-sm font-bold text-navy dark:text-white w-8">{{ leadStats.qualified|default(0) }}</span>
                    </div>
                </div>

                <div class="relative">
                    <div class="flex items-center gap-4 mb-2">
                        <div class="w-24 text-right">
                            <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Converted</span>
                        </div>
                        {% set convertedPct = totalLeads > 0 ? (leadStats.converted|default(0) / totalLeads) * 100 : 0 %}
                        <div class="flex-1">
                            <div class="h-2 bg-gray-100 dark:bg-[#0f1223] rounded-full overflow-hidden">
                                <div class="h-full bg-green-500 rounded-full" style="width: {{ convertedPct }}%"></div>
                            </div>
                        </div>
                         <span class="text-sm font-bold text-navy dark:text-white w-8">{{ leadStats.converted|default(0) }}</span>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 p-4 bg-gold/5 dark:bg-gold/10 rounded-lg border border-gold/20 flex gap-4 items-start">
                  <span class="material-symbols-outlined text-gold mt-0.5">auto_awesome</span>
                  <div>
                      <h4 class="text-sm font-bold text-navy dark:text-white">Funnel Insight</h4>
                      <p class="text-xs text-gray-500 mt-1 leading-relaxed">
                          You are converting <strong class="text-navy dark:text-white">{{ conversionRate|number_format(1) }}%</strong> of leads.
                          {% if conversionRate < 5 %}
                              Review lead qualification criteria to improve quality.
                          {% elseif conversionRate > 20 %}
                              Excellent conversion rate! Consider scaling top channels.
                          {% else %}
                              Standard performance. Focus on nurturing 'New' leads.
                          {% endif %}
                      </p>
                  </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        Chart.defaults.font.family = "'Open Sans', sans-serif";
        Chart.defaults.color = '#94a3b8';
        
        // --- Lead Trend Chart ---
        const trendCtx = document.getElementById('leadTrendChart').getContext('2d');
        const trendGradient = trendCtx.createLinearGradient(0, 0, 0, 300);
        trendGradient.addColorStop(0, 'rgba(83, 109, 254, 0.2)');
        trendGradient.addColorStop(1, 'rgba(83, 109, 254, 0)');

        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: {{ leadTrends|keys|json_encode|raw }},
                datasets: [{
                    label: 'New Leads',
                    data: {{ leadTrends|json_encode|raw }},
                    borderColor: '#536DFE',
                    backgroundColor: trendGradient,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(148, 163, 184, 0.1)' },
                        ticks: { precision: 0 }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });

        // --- Budget Doughnut Chart ---
        const budgetCtx = document.getElementById('budgetChart').getContext('2d');
        new Chart(budgetCtx, {
            type: 'doughnut',
            data: {
                labels: ['Spent', 'Remaining'],
                datasets: [{
                    data: [
                        {{ budgetStats.totalActual }},
                        {{ budgetStats.totalPlanned - budgetStats.totalActual }}
                    ],
                    backgroundColor: ['#536DFE', '#e2e8f0'],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%',
                plugins: {
                    legend: { display: false }
                }
            }
        });

        // --- Channel Bar Chart ---
        const channelCtx = document.getElementById('channelChart').getContext('2d');
        new Chart(channelCtx, {
            type: 'bar',
            data: {
                labels: [{% for item in performanceByChannel %}"{{ item.channelName }}",{% endfor %}],
                datasets: [{
                    label: 'Leads',
                    data: [{% for item in performanceByChannel %}{{ item.leads }},{% endfor %}],
                    backgroundColor: '#1A237E',
                    borderRadius: 4,
                    barThickness: 20
                }, {
                    label: 'Converted',
                    data: [{% for item in performanceByChannel %}{{ item.converted }},{% endfor %}],
                    backgroundColor: '#FFC107',
                    borderRadius: 4,
                    barThickness: 20
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8 } }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(148, 163, 184, 0.1)' },
                        ticks: { precision: 0 }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    });
</script>
{% endblock %}
