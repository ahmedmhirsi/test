{% extends 'back_office/base.html.twig' %}

{% block title %}Marketing Analytics{% endblock %}

{% block breadcrumb %}
    <span class="material-symbols-outlined text-gray-400">chevron_right</span>
    <span class="text-sm font-semibold text-gray-500">Marketing</span>
    <span class="material-symbols-outlined text-gray-400">chevron_right</span>
    <span class="text-sm font-semibold text-navy dark:text-white">Analytics</span>
{% endblock %}

{% block content %}
<div class="p-4 md:p-8 space-y-6">
    
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-display font-black text-navy dark:text-white tracking-tight">Analytics & ROI</h1>
            <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mt-1">Performance insights across all channels</p>
        </div>
        <div class="flex gap-2">
            <button class="h-10 px-4 rounded-lg bg-white dark:bg-[#1a1d2d] border border-gray-200 dark:border-[#2a2e3f] text-gray-600 dark:text-gray-300 text-xs font-bold uppercase tracking-wider hover:bg-gray-50 dark:hover:bg-[#252836] flex items-center gap-2 transition-all">
                <span class="material-symbols-outlined text-[18px]">calendar_today</span>
                Last 30 Days
            </button>
            <button class="h-10 px-4 rounded-lg bg-gold text-navy text-xs font-black uppercase tracking-widest hover:brightness-110 flex items-center justify-center gap-2 shadow-lg shadow-gold/20 transition-all">
                <span class="material-symbols-outlined text-[18px]">download</span>
                Export Report
            </button>
        </div>
    </div>

    <!-- Main KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- CAC Score -->
        <div class="bg-gold rounded-xl p-5 text-navy shadow-lg relative overflow-hidden group hover:shadow-xl transition-all">
            <div class="absolute -right-6 -top-6 w-24 h-24 bg-white/20 rounded-full group-hover:scale-150 transition-transform duration-500"></div>
            <div class="relative z-10 flex flex-col h-full justify-between">
                <div class="flex justify-between items-start">
                    <p class="text-navy/80 text-[10px] font-black uppercase tracking-widest">Avg. CAC</p>
                    <span class="material-symbols-outlined text-navy/80">trending_up</span>
                </div>
                <div class="mt-4">
                    <div class="flex items-end gap-1">
                        <span class="text-3xl font-black tracking-tighter">{{ performanceMetrics.avgCac|number_format(0) }}</span>
                        <span class="text-sm text-navy/60 mb-1 font-bold">TND</span>
                    </div>
                    <div class="flex items-center justify-between mt-2 pt-2 border-t border-navy/10 text-xs font-bold">
                        <span>Acquisition Cost</span>
                        <span class="bg-navy/10 px-2 py-0.5 rounded text-navy">{{ performanceMetrics.avgRoi|number_format(1) }}x ROI</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Spent -->
        <div class="bg-white dark:bg-[#1a1d2d] rounded-xl p-5 border border-gray-100 dark:border-[#2a2e3f] shadow-sm hover:border-red-500/30 transition-all group">
            <div class="flex items-center gap-3 mb-2">
                <div class="p-2 bg-red-50 dark:bg-red-900/20 rounded-lg text-red-600">
                    <span class="material-symbols-outlined">account_balance_wallet</span>
                </div>
                <span class="text-gray-500 dark:text-gray-400 text-xs font-bold uppercase tracking-wider">Total Spent</span>
            </div>
            <div>
                <span class="text-2xl font-black text-navy dark:text-white">{{ performanceMetrics.totalSpent|number_format(0) }} <span class="text-sm text-gray-400">TND</span></span>
                <p class="text-xs text-gray-500 mt-1">Across all campaigns</p>
            </div>
        </div>

        <!-- Total Leads -->
        <div class="bg-white dark:bg-[#1a1d2d] rounded-xl p-5 border border-gray-100 dark:border-[#2a2e3f] shadow-sm hover:border-primary/30 transition-all group">
            <div class="flex items-center gap-3 mb-2">
                <div class="p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-blue-600">
                    <span class="material-symbols-outlined">groups</span>
                </div>
                <span class="text-gray-500 dark:text-gray-400 text-xs font-bold uppercase tracking-wider">Total Leads</span>
            </div>
            <div>
                <span class="text-2xl font-black text-navy dark:text-white">{{ performanceMetrics.totalLeads }}</span>
                <p class="text-xs text-gray-500 mt-1">Potential customers</p>
            </div>
        </div>

        <!-- Conversion Rate -->
        <div class="bg-white dark:bg-[#1a1d2d] rounded-xl p-5 border border-gray-100 dark:border-[#2a2e3f] shadow-sm hover:border-purple-500/30 transition-all group">
            <div class="flex items-center gap-3 mb-2">
                <div class="p-2 bg-purple-50 dark:bg-purple-900/20 rounded-lg text-purple-600">
                    <span class="material-symbols-outlined">conversion_path</span>
                </div>
                <span class="text-gray-500 dark:text-gray-400 text-xs font-bold uppercase tracking-wider">Conversion</span>
            </div>
            <div>
                {% set conversionRate = performanceMetrics.totalLeads > 0 ? (performanceMetrics.totalConverted / performanceMetrics.totalLeads) * 100 : 0 %}
                <span class="text-2xl font-black text-navy dark:text-white">{{ conversionRate|number_format(1) }}%</span>
                <p class="text-xs text-gray-500 mt-1">{{ performanceMetrics.totalConverted }} won deals</p>
            </div>
        </div>
    </div>

    <!-- Charts Row 1: Trends & Distribution -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Lead Trend Line Chart -->
        <div class="md:col-span-2 bg-white dark:bg-[#1a1d2d] rounded-xl border border-gray-100 dark:border-[#2a2e3f] shadow-sm p-6">
            <h3 class="text-lg font-display font-bold text-navy dark:text-white mb-6">Lead Acquisition Trend</h3>
            <div class="h-64">
                <canvas id="leadTrendChart"></canvas>
            </div>
        </div>

        <!-- Budget Doughnut Chart -->
        <div class="bg-white dark:bg-[#1a1d2d] rounded-xl border border-gray-100 dark:border-[#2a2e3f] shadow-sm p-6">
            <h3 class="text-lg font-display font-bold text-navy dark:text-white mb-6">Budget Distribution</h3>
            <div class="h-48 relative">
                <canvas id="budgetChart"></canvas>
                <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                    <span class="text-2xl font-black text-navy dark:text-white">{{ budgetStats.totalPlanned|number_format(0, '.', 'k') }}</span>
                    <span class="text-[10px] uppercase text-gray-400 font-bold">Total</span>
                </div>
            </div>
            <div class="mt-6 space-y-3">
                <div class="flex justify-between items-center text-xs">
                    <span class="flex items-center gap-2 text-gray-600 dark:text-gray-300"><span class="w-2 h-2 rounded-full bg-primary"></span> Spent</span>
                    <span class="font-bold text-navy dark:text-white">{{ budgetStats.totalActual|number_format(0) }} TND</span>
                </div>
                <div class="flex justify-between items-center text-xs">
                    <span class="flex items-center gap-2 text-gray-600 dark:text-gray-300"><span class="w-2 h-2 rounded-full bg-gray-200 dark:bg-gray-700"></span> Remaining</span>
                    <span class="font-bold text-navy dark:text-white">{{ (budgetStats.totalPlanned - budgetStats.totalActual)|number_format(0) }} TND</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2: Channel Performance & Funnel -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Channel Bar Chart -->
        <div class="bg-white dark:bg-[#1a1d2d] rounded-xl border border-gray-100 dark:border-[#2a2e3f] shadow-sm p-6">
            <h3 class="text-lg font-display font-bold text-navy dark:text-white mb-6">Channel Performance</h3>
            <div class="h-64">
                <canvas id="channelChart"></canvas>
            </div>
        </div>

        <!-- Lead Funnel -->
        <div class="bg-white dark:bg-[#1a1d2d] rounded-xl border border-gray-100 dark:border-[#2a2e3f] shadow-sm p-6">
            <h3 class="text-lg font-display font-bold text-navy dark:text-white mb-6">Lead Funnel</h3>
            <div class="space-y-6">
                <!-- Funnel Step: New -->
                <div class="relative">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">New Leads</span>
                        <span class="text-sm font-bold text-navy dark:text-white">{{ leadStats.new|default(0) }}</span>
                    </div>
                    {% set totalLeads = leadStats.total|default(0) %}
                    {% set newPct = totalLeads > 0 ? (leadStats.new|default(0) / totalLeads) * 100 : 0 %}
                    <div class="h-2 bg-gray-100 dark:bg-[#252836] rounded-full overflow-hidden">
                        <div class="h-full bg-blue-500 rounded-full" style="width: {{ newPct }}%"></div>
                    </div>
                </div>

                <!-- Funnel Step: Qualified -->
                <div class="relative">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Qualified</span>
                        <span class="text-sm font-bold text-navy dark:text-white">{{ leadStats.qualified|default(0) }}</span>
                    </div>
                    {% set qualifiedPct = totalLeads > 0 ? (leadStats.qualified|default(0) / totalLeads) * 100 : 0 %}
                    <div class="h-2 bg-gray-100 dark:bg-[#252836] rounded-full overflow-hidden">
                        <div class="h-full bg-purple-500 rounded-full" style="width: {{ qualifiedPct }}%"></div>
                    </div>
                </div>

                <!-- Funnel Step: Converted -->
                <div class="relative">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Converted</span>
                        <span class="text-sm font-bold text-navy dark:text-white">{{ leadStats.converted|default(0) }}</span>
                    </div>
                    {% set convertedPct = totalLeads > 0 ? (leadStats.converted|default(0) / totalLeads) * 100 : 0 %}
                    <div class="h-2 bg-gray-100 dark:bg-[#252836] rounded-full overflow-hidden">
                        <div class="h-full bg-green-500 rounded-full" style="width: {{ convertedPct }}%"></div>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 p-4 bg-gray-50 dark:bg-[#252836] rounded-lg border border-gray-100 dark:border-[#2a2e3f] flex gap-3 items-start">
                  <span class="material-symbols-outlined text-gold mt-0.5">auto_awesome</span>
                  <div>
                      <h4 class="text-sm font-bold text-navy dark:text-white">Funnel Insight</h4>
                      <p class="text-xs text-gray-500 mt-1 leading-relaxed">
                          You are converting <strong class="text-navy dark:text-white">{{ conversionRate|number_format(1) }}%</strong> of leads.
                          {% if conversionRate < 5 %}
                              Review lead qualification criteria to improve quality.
                          {% elseif conversionRate > 20 %}
                              Excellent conversion rate! Consider scaling top channels.
                          {% else %}
                              Standard performance. Focus on nurturing 'New' leads.
                          {% endif %}
                      </p>
                  </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof Chart === 'undefined') return;

        Chart.defaults.font.family = "'Open Sans', sans-serif";
        Chart.defaults.color = '#94a3b8';
        
        // --- Lead Trend Chart ---
        const trendCanvas = document.getElementById('leadTrendChart');
        if (trendCanvas) {
            const trendCtx = trendCanvas.getContext('2d');
            const trendGradient = trendCtx.createLinearGradient(0, 0, 0, 300);
            trendGradient.addColorStop(0, 'rgba(83, 109, 254, 0.2)');
            trendGradient.addColorStop(1, 'rgba(83, 109, 254, 0)');

            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: {{ leadTrends|keys|json_encode|raw }},
                    datasets: [{
                        label: 'New Leads',
                        data: {{ leadTrends|json_encode|raw }},
                        borderColor: '#536DFE',
                        backgroundColor: trendGradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(148, 163, 184, 0.1)' },
                            ticks: { precision: 0 }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // --- Budget Doughnut Chart ---
        const budgetCanvas = document.getElementById('budgetChart');
        if (budgetCanvas) {
            const budgetCtx = budgetCanvas.getContext('2d');
            new Chart(budgetCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Spent', 'Remaining'],
                    datasets: [{
                        data: [
                            {{ budgetStats.totalActual }},
                            {{ budgetStats.totalPlanned - budgetStats.totalActual }}
                        ],
                        backgroundColor: ['#536DFE', '#e2e8f0'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // --- Channel Bar Chart ---
        const channelCanvas = document.getElementById('channelChart');
        if (channelCanvas) {
            const channelCtx = channelCanvas.getContext('2d');
            new Chart(channelCtx, {
                type: 'bar',
                data: {
                    labels: [{% for item in performanceByChannel %}"{{ item.channelName }}",{% endfor %}],
                    datasets: [{
                        label: 'Leads',
                        data: [{% for item in performanceByChannel %}{{ item.leads }},{% endfor %}],
                        backgroundColor: '#1A237E',
                        borderRadius: 4,
                        barThickness: 20
                    }, {
                        label: 'Converted',
                        data: [{% for item in performanceByChannel %}{{ item.converted }},{% endfor %}],
                        backgroundColor: '#FFC107',
                        borderRadius: 4,
                        barThickness: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8 } }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(148, 163, 184, 0.1)' },
                            ticks: { precision: 0 }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}
