{% extends 'back_office/base.html.twig' %}

{% block title %}Campaigns Command - Nexus AI{% endblock %}

{% block header_title %}
    <span class="flex items-center gap-2">
        <span class="material-symbols-outlined text-nexus-primary animate-pulse-slow">campaign</span>
        Campaigns Command
    </span>
{% endblock %}

{% block content %}
<div class="swup-transition-fade pb-20">

    {# ─── Header ─── #}
    <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
        <div>
            <h1 class="text-4xl font-black text-white tracking-tight leading-tight animate-slide-up">
                Campagnes <span class="text-transparent bg-clip-text bg-gradient-to-r from-nexus-primary to-green-400">Actives</span>
            </h1>
            <p class="text-gray-400 text-sm mt-2 animate-slide-up" style="animation-delay: 0.1s">
                Planification stratégique et suivi opérationnel.
            </p>
        </div>
        
        <div class="flex gap-3 animate-slide-up" style="animation-delay: 0.2s">
            <a href="{{ path('app_marketing_campaigns_pdf') }}" class="glass-panel px-4 py-2 flex items-center gap-2 rounded-full hover:bg-white/10 transition-colors group">
                <span class="material-symbols-outlined text-red-400 group-hover:scale-110 transition-transform">picture_as_pdf</span>
                <span class="text-xs font-bold text-gray-300 uppercase tracking-wider">Rapport</span>
            </a>
            <a href="{{ path('app_marketing_campaign_new') }}" class="btn-nexus-primary rounded-full px-6 py-2 flex items-center gap-2 shadow-lg shadow-nexus-primary/30 group">
                <span class="material-symbols-outlined text-lg group-hover:rotate-12 transition-transform">add</span>
                <span>Nouvelle Campagne</span>
            </a>
        </div>
    </div>

    {# ─── Controls & Grid ─── #}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-slide-up" style="animation-delay: 0.3s">
        
        {# Left Column: Campaign List #}
        <div class="glass-panel p-4 lg:col-span-1 h-[calc(100vh-250px)] flex flex-col">
            
            {# Search & Sort #}
            <div class="mb-4 space-y-3">
                <form method="get" action="{{ path('app_marketing_campaigns') }}" class="relative">
                    <input type="text" name="q" value="{{ search }}" placeholder="Rechercher..." 
                           class="w-full pl-9 pr-4 py-2 bg-white/5 border border-white/10 rounded-lg text-sm text-white focus:ring-1 focus:ring-nexus-primary">
                    <span class="absolute left-3 top-2.5 text-gray-500 material-symbols-outlined text-[18px]">search</span>
                </form>
                
                <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                    <a href="{{ path('app_marketing_campaigns', {q: search, sort: 'status', order: 'ASC'}) }}" 
                       class="px-3 py-1 bg-white/5 rounded-full text-[10px] font-bold text-gray-400 hover:text-white hover:bg-nexus-primary/20 transition-colors whitespace-nowrap border border-white/5">
                        Par Statut
                    </a>
                    <a href="{{ path('app_marketing_campaigns', {q: search, sort: 'startDate', order: 'DESC'}) }}" 
                       class="px-3 py-1 bg-white/5 rounded-full text-[10px] font-bold text-gray-400 hover:text-white hover:bg-nexus-primary/20 transition-colors whitespace-nowrap border border-white/5">
                        Par Date
                    </a>
                </div>
            </div>

            {# Scrollable List #}
            <div class="flex-1 overflow-y-auto space-y-2 pr-1">
                {% for campaign in campaigns %}
                 <a href="{{ path('app_marketing_campaign_show', {id: campaign.id}) }}" 
                   class="block p-3 rounded-lg border border-transparent transition-all group relative overflow-hidden
                          {% if selectedCampaign and selectedCampaign.id == campaign.id %}bg-nexus-primary/10 border-nexus-primary/30{% else %}bg-white/5 hover:bg-white/10 hover:border-white/10{% endif %}">
                    
                    {# Active Indicator #}
                    {% if selectedCampaign and selectedCampaign.id == campaign.id %}
                        <div class="absolute left-0 top-0 bottom-0 w-1 bg-nexus-primary shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div>
                    {% endif %}

                    <div class="flex justify-between items-start mb-1 pl-2">
                        <h4 class="font-bold text-white text-sm truncate pr-2">{{ campaign.name }}</h4>
                        <div class="size-2 rounded-full shrink-0 mt-1.5
                            {% if campaign.status == 'active' %}bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.6)]
                            {% elseif campaign.status == 'planned' %}bg-blue-500
                            {% elseif campaign.status == 'paused' %}bg-amber-500
                            {% else %}bg-gray-500{% endif %}">
                        </div>
                    </div>
                    
                    <div class="pl-2 flex items-center justify-between mt-2">
                        <span class="text-[10px] font-mono text-gray-500">{{ campaign.startDate|date('d/m/y') }}</span>
                         <span class="text-[10px] uppercase font-bold tracking-wider
                            {% if campaign.status == 'active' %}text-green-400
                            {% elseif campaign.status == 'planned' %}text-blue-400
                            {% elseif campaign.status == 'paused' %}text-amber-400
                            {% else %}text-gray-400{% endif %}">
                            {{ campaign.statusLabel }}
                        </span>
                    </div>
                </a>
                {% else %}
                    <div class="text-center py-8 text-gray-600">
                        <p class="text-xs">Aucune campagne</p>
                    </div>
                {% endfor %}
            </div>
        </div>

        {# Right Column: Detail View #}
        <div class="lg:col-span-2 space-y-6">
            {% if selectedCampaign %}
                {# Main Card #}
                <div class="glass-panel p-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-nexus-primary/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
                    
                    <div class="flex flex-col md:flex-row justify-between items-start gap-6 relative z-10">
                        <div class="flex items-start gap-4">
                            <div class="size-16 rounded-2xl bg-gradient-to-br from-gray-800 to-black border border-white/10 flex items-center justify-center shadow-inner">
                                <span class="material-symbols-outlined text-4xl text-nexus-primary">campaign</span>
                            </div>
                            <div>
                                <h2 class="text-2xl font-black text-white mb-1">{{ selectedCampaign.name }}</h2>
                                <p class="text-sm text-gray-400 max-w-md line-clamp-2">{{ selectedCampaign.objective|default('Aucun objectif défini') }}</p>
                                
                                <div class="flex items-center gap-4 mt-3">
                                     <span class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded text-[10px] font-bold border border-white/10 bg-white/5 text-gray-300">
                                        <span class="material-symbols-outlined text-[14px]">calendar_today</span>
                                        {{ selectedCampaign.startDate|date('d M Y') }}
                                    </span>
                                    <span class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded text-[10px] font-bold border border-white/10 bg-white/5 text-gray-300">
                                        <span class="material-symbols-outlined text-[14px]">target</span>
                                        Cible: <span class="text-white">{{ selectedCampaign.targetLeads }}</span>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-2">
                            <a href="{{ path('app_marketing_email_bulk_compose', {id: selectedCampaign.id}) }}" class="px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 text-white text-xs font-bold transition-all flex items-center gap-2 group">
                                <span class="material-symbols-outlined text-[16px] group-hover:text-nexus-primary transition-colors">forward_to_inbox</span>
                                Emailing
                            </a>
                            <a href="{{ path('app_marketing_campaign_edit', {id: selectedCampaign.id}) }}" class="size-9 rounded-lg bg-white/5 hover:bg-nexus-accent hover:text-white flex items-center justify-center text-gray-400 transition-all">
                                <span class="material-symbols-outlined text-[18px]">edit</span>
                            </a>
                        </div>
                    </div>

                     {# Stats Mini-Grid #}
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8 pt-6 border-t border-white/5">
                        <div>
                            <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1">Target Leads</p>
                            <p class="text-2xl font-black text-white">{{ selectedCampaign.targetLeads }}</p>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1">Acquis</p>
                            <p class="text-2xl font-black text-white flex items-end gap-2">
                                {{ selectedCampaign.leads|length }}
                                {% if selectedCampaign.targetLeads > 0 %}
                                    <span class="text-xs font-bold text-nexus-primary mb-1">
                                        {{ ((selectedCampaign.leads|length / selectedCampaign.targetLeads) * 100)|number_format(0) }}%
                                    </span>
                                {% endif %}
                            </p>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1">Budget</p>
                            <p class="text-2xl font-black text-white">{{ budgetTotals.planned|default(0)|number_format(0) }}</p>
                        </div>
                         <div>
                            <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1">Dépensé</p>
                            <p class="text-2xl font-black text-white">{{ budgetTotals.actual|default(0)|number_format(0) }}</p>
                        </div>
                    </div>
                </div>

                {# Channels Grid #}
                <div>
                     <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-nexus-accent">hub</span>
                        Canaux Activés
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        {% for cc in selectedCampaign.campaignChannels %}
                            <div class="glass-panel p-4 flex flex-col items-center text-center gap-2 hover:bg-white/5 transition-colors cursor-default">
                                <span class="text-2xl pt-2">{{ cc.channel.icon }}</span>
                                <span class="text-sm font-bold text-white">{{ cc.channel.name }}</span>
                                <span class="px-2 py-0.5 rounded-full bg-white/5 text-[10px] text-gray-400 border border-white/5">{{ cc.expectedLeads }} leads esp.</span>
                            </div>
                        {% else %}
                            <div class="col-span-full py-8 text-center border border-dashed border-white/10 rounded-xl text-gray-500 text-sm">
                                Aucun canal configuré
                            </div>
                        {% endfor %}
                    </div>
                </div>

            {% else %}
                 <div class="glass-panel h-full flex flex-col items-center justify-center text-center p-12 min-h-[400px]">
                    <div class="size-24 rounded-full bg-white/5 flex items-center justify-center mb-6 animate-pulse-slow">
                        <span class="material-symbols-outlined text-5xl text-gray-600">campaign</span>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">Sélectionnez une campagne</h2>
                    <p class="text-gray-400 max-w-xs mx-auto">Choisissez une campagne dans la liste pour voir les détails stratégiques et opérationnels.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
