{% extends 'back_office/base.html.twig' %}
{% import '_components.html.twig' as ui %}

{% block title %}Growth Operations Hub – SmartNexus AI{% endblock %}

{% block header_title %}
    <span class="flex items-center gap-2">
        <span class="material-symbols-outlined text-nexus-primary">campaign</span>
        Strategic Growth Oversight
    </span>
{% endblock %}

{% block content %}
<div class="swup-transition-fade pb-20">

    {# ─── Header ─── #}
    <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4 animate-card">
        <div>
            <p class="text-[11px] font-bold text-[#A79E9C] tracking-wider uppercase mb-2">Internal Environment</p>
            <h1 class="text-4xl font-extrabold text-[#D3C3B9] tracking-tight leading-tight">
                Marketing <span class="text-[#A79E9C]">Performance</span>
            </h1>
            <p class="text-[#A79E9C]/80 text-sm font-medium mt-2">
                Real-time acquisition metrics and campaign orchestration.
            </p>
        </div>
        
        <div class="flex gap-3">
             {% if is_granted('ROLE_ADMIN') %}
            <a href="{{ path('app_marketing_analytics') }}" class="glass-panel px-5 py-2.5 flex items-center gap-2 rounded-xl bg-slate-800 border-white/5 hover:bg-slate-700 transition-all group">
                <span class="material-symbols-outlined text-nexus-primary group-hover:scale-110 transition-transform">analytics</span>
                <span class="text-[11px] font-bold text-slate-300 uppercase tracking-widest">Analytics</span>
            </a>
            {% endif %}
            <a href="{{ path('app_marketing_campaign_new') }}" class="btn-nexus-primary rounded-xl px-6 py-2.5 flex items-center gap-2 shadow-xl shadow-nexus-primary/20 group">
                <span class="material-symbols-outlined text-[20px] group-hover:rotate-12 transition-transform">add_circle</span>
                <span class="text-[11px] font-bold uppercase tracking-widest">Initiate Campaign</span>
            </a>
        </div>
    </div>

    {# ─── Bento Grid ─── #}
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 animate-card" style="animation-delay: 0.1s">
        
        {# Large Stat: Total Leads #}
        <div class="col-span-1 md:col-span-2 glass-panel p-6 group border-l-4 border-l-nexus-primary">
            <div class="flex items-start justify-between mb-8">
                <div>
                     <p class="text-[11px] font-bold text-[#A79E9C] uppercase tracking-wider mb-1">Total Prospect Pool</p>
                    <h3 class="text-4xl font-black text-[#D3C3B9]">{{ leadStats.total }}</h3>
                </div>
                <div class="size-12 rounded-xl bg-[#161516] border border-white/5 flex items-center justify-center text-[#B58863] shadow-lg">
                    <span class="material-symbols-outlined text-[28px]">groups</span>
                </div>
            </div>
            
            <div class="flex items-end gap-3">
                <span class="text-emerald-400 font-bold flex items-center gap-1 bg-emerald-500/10 px-2.5 py-1 rounded-lg text-[10px] border border-emerald-500/10">
                    <span class="material-symbols-outlined text-[14px]">arrow_upward</span>
                    {{ leadStats.new }} Recent Entries
                </span>
                <span class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Current Period</span>
            </div>
        </div>

        {# Stat: Conversion Rate #}
        <div class="glass-panel p-6 border-l-4 border-l-[#B58863] group">
            <p class="text-[11px] font-bold text-[#A79E9C] uppercase tracking-wider mb-4">Conversion Index</p>
            <h3 class="text-4xl font-black text-[#D3C3B9] mb-2">{{ leadStats.conversionRate }}<span class="text-lg text-[#3D4D55]">%</span></h3>
            <div class="flex items-center gap-2">
                <div class="size-1.5 rounded-full bg-[#B58863]"></div>
                <p class="text-[10px] font-bold text-[#A79E9C] uppercase tracking-widest">{{ leadStats.converted }} Validated Leads</p>
            </div>
        </div>

        {# Stat: Budget #}
        <div class="glass-panel p-6 border-l-4 border-l-slate-600 group">
            <p class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-4">Capital Allocation</p>
            <div class="flex flex-col h-[80px] justify-between">
                <h3 class="text-2xl font-black text-white leading-none">{{ budgetStats.totalActual|number_format(0) }} <span class="text-xs font-bold text-slate-600 uppercase">TND</span></h3>
                <div>
                    <div class="flex justify-between items-center mb-1.5">
                        <span class="text-[9px] font-bold text-slate-600 uppercase tracking-widest">Utilization</span>
                        <span class="text-[9px] font-bold text-white">{% set budgetPercent = budgetStats.totalPlanned > 0 ? (budgetStats.totalActual / budgetStats.totalPlanned * 100) : 0 %}{{ budgetPercent|round }}%</span>
                    </div>
                    <div class="w-full bg-slate-800 h-1 rounded-full overflow-hidden">
                        <div class="h-full bg-slate-500 transition-all duration-500" style="width: {{ budgetPercent }}%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# ─── Active Campaigns & Actions ─── #}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-card" style="animation-delay: 0.2s">
        
        {# Campaign Registry #}
        <div class="col-span-1 lg:col-span-2 glass-panel overflow-hidden flex flex-col">
            <div class="p-5 border-b border-white/5 bg-slate-900/50 flex items-center justify-between">
                <h3 class="text-sm font-bold text-white uppercase tracking-widest flex items-center gap-3">
                    <span class="size-2 rounded-full bg-nexus-primary"></span>
                    Campaign Registry
                </h3>
                <a href="{{ path('app_marketing_campaigns') }}" class="text-[10px] font-bold text-slate-500 hover:text-white transition-colors uppercase tracking-widest">Full Directory</a>
            </div>
            
            <div class="divide-y divide-white/5 overflow-y-auto max-h-[400px] custom-scrollbar">
                {% for campaign in campaigns|slice(0, 5) %}
                <div class="p-5 hover:bg-white/[0.02] transition-colors group cursor-pointer">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-5">
                            <div class="size-2 rounded-full 
                                {% if campaign.status == 'active' %}bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.4)]
                                {% elseif campaign.status == 'planned' %}bg-nexus-primary shadow-[0_0_8px_rgba(79,70,229,0.4)]
                                {% else %}bg-slate-600{% endif %}">
                            </div>
                            
                            <div>
                                <h4 class="font-bold text-white text-sm group-hover:text-nexus-primary transition-colors tracking-tight">{{ campaign.name }}</h4>
                                <p class="text-[10px] font-bold text-slate-600 uppercase tracking-widest mt-0.5">
                                    {{ campaign.startDate|date('d M') }} — {{ campaign.endDate ? campaign.endDate|date('d M') : 'Indefinite' }}
                                </p>
                            </div>
                        </div>

                        <div class="text-right">
                             <div class="text-[10px] font-bold text-slate-500 mb-2 uppercase tracking-widest">
                                <strong class="text-white">{{ campaign.leads|length }}</strong> / {{ campaign.targetLeads }} Acquisition
                            </div>
                            <div class="w-24 h-1 bg-slate-800 rounded-full overflow-hidden ml-auto">
                                {% set progress = campaign.targetLeads > 0 ? (campaign.leads|length / campaign.targetLeads * 100) : 0 %}
                                <div class="h-full bg-nexus-primary transition-all duration-500" style="width: {{ progress }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="py-20 text-center text-slate-600">
                    <span class="material-symbols-outlined text-[48px] mb-2 opacity-20">campaign</span>
                    <p class="text-xs font-bold uppercase tracking-widest">No active campaigns detected.</p>
                </div>
                {% endfor %}
            </div>
        </div>

        {# Quick Actions & AI Insight #}
        <div class="space-y-6">
            {# Operational Controls #}
            <div class="glass-panel p-6">
                <h3 class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-5">Operational Controls</h3>
                <div class="grid grid-cols-2 gap-3">
                    <a href="{{ path('app_marketing_leads') }}" class="p-5 rounded-2xl bg-slate-800 border border-white/5 hover:border-nexus-primary/30 transition-all group flex flex-col items-center gap-3">
                        <span class="material-symbols-outlined text-slate-400 group-hover:text-white group-hover:scale-110 transition-all">groups</span>
                        <span class="text-[10px] font-bold text-slate-500 group-hover:text-white uppercase tracking-widest">Leads</span>
                    </a>
                    {% if is_granted('ROLE_ADMIN') %}
                    <a href="{{ path('app_marketing_channels') }}" class="p-5 rounded-2xl bg-slate-800 border border-white/5 hover:border-nexus-primary/30 transition-all group flex flex-col items-center gap-3">
                        <span class="material-symbols-outlined text-slate-400 group-hover:text-white group-hover:scale-110 transition-all">hub</span>
                        <span class="text-[10px] font-bold text-slate-500 group-hover:text-white uppercase tracking-widest">Channels</span>
                    </a>
                    {% endif %}
                </div>
            </div>

            {# AI Insight #}
            <div class="glass-panel p-6 bg-slate-900/50 border-nexus-primary/10">
                <div class="flex items-center gap-3 mb-4">
                    <div class="size-8 rounded-lg bg-nexus-primary/10 flex items-center justify-center text-nexus-primary border border-nexus-primary/20">
                         <span class="material-symbols-outlined text-[18px]">psychology</span>
                    </div>
                    <h3 class="text-[11px] font-bold text-white uppercase tracking-widest">Predictive Analysis</h3>
                </div>
                <p class="text-[11px] text-slate-500 leading-relaxed font-medium">
                    {% if leadStats.total > 0 %}
                        Average Acquisition Cost (CAC) established at <strong class="text-white">{{ performanceMetrics.avgCac|number_format(0) }} TND</strong>. 
                        {% if performanceMetrics.avgCac < 500 %}
                            Efficiency rating is optimal. 
                        {% else %}
                            Network optimization highly recommended to reduce CAC baseline.
                        {% endif %}
                    {% else %}
                        Insufficient data. Initiate foundational campaign to generate performance projections.
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
