{% extends 'base.html.twig' %}

{% block title %}Enregistrer - Collaboration{% endblock %}

{% block body %}
<div class="flex flex-col h-screen bg-gray-100 dark:bg-gray-900">
    
    <!-- Toolbar -->
    <div class="flex items-center justify-between bg-white dark:bg-[#1a1d2d] border-b border-gray-200 dark:border-gray-700 px-4 py-3 shadow-sm">
        <div class="flex items-center gap-4">
            <a href="{{ path('app_recording_index') }}" class="text-gray-500 hover:text-primary">
                <span class="material-symbols-outlined">arrow_back</span>
            </a>
            <div>
                <h1 class="font-bold text-navy dark:text-white">Nouvel Enregistrement</h1>
                <p class="text-xs text-gray-500" id="status">PrÃªt Ã  enregistrer</p>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button id="startBtn" class="px-6 py-3 bg-red-500 text-white rounded-lg font-bold hover:brightness-110 flex items-center gap-2">
                <span class="material-symbols-outlined">fiber_manual_record</span>
                DÃ©marrer
            </button>
            <button id="stopBtn" class="px-6 py-3 bg-gray-400 text-white rounded-lg font-bold cursor-not-allowed flex items-center gap-2" disabled>
                <span class="material-symbols-outlined">stop</span>
                ArrÃªter
            </button>
            <button id="saveBtn" class="px-6 py-3 bg-gold text-navy rounded-lg font-bold hover:brightness-110 hidden flex items-center gap-2">
                <span class="material-symbols-outlined">save</span>
                Sauvegarder
            </button>
        </div>
    </div>

    <!-- Recording Area -->
    <div class="flex-1 overflow-auto p-8">
        <div class="max-w-4xl mx-auto space-y-6">
            
            <!-- Video Preview -->
            <div class="bg-white dark:bg-[#1a1d2d] rounded-xl border border-gray-100 dark:border-[#2a2e3f] shadow-sm p-6">
                <h2 class="text-lg font-bold text-navy dark:text-white mb-4">AperÃ§u</h2>
                <div class="relative bg-black rounded-lg overflow-hidden" style="aspect-ratio: 16/9;">
                    <video id="preview" autoplay muted class="w-full h-full object-cover"></video>
                    <div id="recordingIndicator" class="hidden absolute top-4 left-4 flex items-center gap-2 bg-red-500 text-white px-3 py-1 rounded-full">
                        <span class="w-3 h-3 bg-white rounded-full animate-pulse"></span>
                        <span class="text-sm font-bold" id="timer">00:00</span>
                    </div>
                </div>
            </div>

            <!-- Recording Info -->
            <div class="bg-white dark:bg-[#1a1d2d] rounded-xl border border-gray-100 dark:border-[#2a2e3f] shadow-sm p-6">
                <h2 class="text-lg font-bold text-navy dark:text-white mb-4">Informations</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-navy dark:text-white mb-2">Titre</label>
                        <input type="text" id="titleInput" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-800 text-navy dark:text-white" placeholder="Titre de l'enregistrement" value="Enregistrement {{ 'now'|date('d/m/Y H:i') }}">
                    </div>
                    {% if meeting %}
                        <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                            <p class="text-sm font-semibold text-blue-900 dark:text-blue-300">
                                <span class="material-symbols-outlined text-[16px] inline">event</span>
                                Meeting: {{ meeting.titre }}
                            </p>
                        </div>
                        <input type="hidden" id="meetingId" value="{{ meeting.id }}">
                    {% endif %}
                </div>
            </div>

        </div>
    </div>

</div>

<style>
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
.animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}
</style>

<script>
console.log('ðŸŽ¥ Initialisation de l\'enregistrement...');

let mediaRecorder;
let recordedChunks = [];
let stream;
let startTime;
let timerInterval;

const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const saveBtn = document.getElementById('saveBtn');
const preview = document.getElementById('preview');
const status = document.getElementById('status');
const recordingIndicator = document.getElementById('recordingIndicator');
const timer = document.getElementById('timer');

// Check browser support
if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    console.error('âŒ MediaDevices API non supportÃ©e');
    status.textContent = 'Erreur: Votre navigateur ne supporte pas l\'enregistrement';
    startBtn.disabled = true;
    alert('Votre navigateur ne supporte pas l\'enregistrement vidÃ©o. Utilisez Chrome, Firefox ou Edge.');
}

// Request camera and microphone access
async function initMedia() {
    try {
        console.log('ðŸ“¹ Demande d\'accÃ¨s mÃ©dia...');
        
        // Try video + audio first
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true
                }
            });
            console.log('âœ… VidÃ©o + Audio OK');
        } catch (e) {
            console.warn('âš ï¸ VidÃ©o+Audio Ã©chouÃ©, essai audio seul...', e);
            // Fallback to audio only
            stream = await navigator.mediaDevices.getUserMedia({
                audio: true
            });
            console.log('âœ… Audio seul OK');
        }
        
        preview.srcObject = stream;
        status.textContent = 'PrÃªt Ã  enregistrer';
        startBtn.disabled = false;
        startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        console.log('âœ… MÃ©dia initialisÃ©');
        
        return true;
    } catch (error) {
        console.error('âŒ Erreur mÃ©dia:', error);
        status.textContent = 'Erreur: ' + error.message;
        
        if (error.name === 'NotAllowedError') {
            alert('Vous devez autoriser l\'accÃ¨s Ã  votre camÃ©ra et microphone.\n\nCliquez sur l\'icÃ´ne ðŸ”’ dans la barre d\'adresse et autorisez l\'accÃ¨s.');
        } else if (error.name === 'NotFoundError') {
            alert('Aucune camÃ©ra ou microphone dÃ©tectÃ©.\n\nVÃ©rifiez que vos pÃ©riphÃ©riques sont bien connectÃ©s.');
        } else {
            alert('Erreur d\'accÃ¨s mÃ©dia: ' + error.message);
        }
        
        return false;
    }
}

// Start recording
startBtn.onclick = async () => {
    console.log('ðŸ”´ Tentative de dÃ©marrage...');
    
    if (!stream) {
        const success = await initMedia();
        if (!success) {
            console.error('âŒ Impossible d\'initialiser le mÃ©dia');
            return;
        }
    }

    recordedChunks = [];
    
    try {
        // Check supported mime types
        const mimeTypes = [
            'video/webm;codecs=vp9,opus',
            'video/webm;codecs=vp8,opus',
            'video/webm',
            'audio/webm'
        ];
        
        let selectedMimeType = null;
        for (const mimeType of mimeTypes) {
            if (MediaRecorder.isTypeSupported(mimeType)) {
                selectedMimeType = mimeType;
                console.log('âœ… Format supportÃ©:', mimeType);
                break;
            }
        }
        
        if (!selectedMimeType) {
            throw new Error('Aucun format d\'enregistrement supportÃ©');
        }

        mediaRecorder = new MediaRecorder(stream, {
            mimeType: selectedMimeType
        });

        mediaRecorder.ondataavailable = (event) => {
            if (event.data && event.data.size > 0) {
                recordedChunks.push(event.data);
                console.log('ðŸ“¦ Chunk reÃ§u:', event.data.size, 'bytes');
            }
        };

        mediaRecorder.onstop = () => {
            console.log('ðŸŽ¬ Enregistrement arrÃªtÃ© -', recordedChunks.length, 'chunks');
            clearInterval(timerInterval);
            saveBtn.classList.remove('hidden');
            status.textContent = 'Enregistrement terminÃ© - Cliquez sur Sauvegarder';
        };

        mediaRecorder.onerror = (event) => {
            console.error('âŒ Erreur MediaRecorder:', event.error);
            status.textContent = 'Erreur d\'enregistrement';
        };

        mediaRecorder.start(1000); // Collect data every second
        
        startTime = Date.now();
        startBtn.disabled = true;
        startBtn.classList.add('opacity-50', 'cursor-not-allowed');
        stopBtn.disabled = false;
        stopBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
        stopBtn.classList.add('bg-red-600');
        
        recordingIndicator.classList.remove('hidden');
        status.textContent = 'Enregistrement en cours...';
        
        // Update timer
        timerInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            timer.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }, 1000);
        
        console.log('ðŸ”´ Enregistrement dÃ©marrÃ© avec', selectedMimeType);
    } catch (error) {
        console.error('âŒ Erreur enregistrement:', error);
        status.textContent = 'Erreur: ' + error.message;
        alert('Erreur lors du dÃ©marrage de l\'enregistrement:\n' + error.message);
    }
};

// Stop recording
stopBtn.onclick = () => {
    console.log('â¹ï¸ ArrÃªt demandÃ©...');
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        startBtn.disabled = false;
        startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        stopBtn.disabled = true;
        stopBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
        stopBtn.classList.remove('bg-red-600');
        recordingIndicator.classList.add('hidden');
    }
};

// Save recording
saveBtn.onclick = async () => {
    if (recordedChunks.length === 0) {
        alert('Aucun enregistrement Ã  sauvegarder');
        return;
    }

    console.log('ðŸ’¾ Sauvegarde de', recordedChunks.length, 'chunks...');
    status.textContent = 'Sauvegarde en cours...';
    saveBtn.disabled = true;

    const blob = new Blob(recordedChunks, { type: 'video/webm' });
    console.log('ðŸ“¦ Blob crÃ©Ã©:', blob.size, 'bytes');
    
    const formData = new FormData();
    formData.append('recording', blob, 'recording.webm');
    formData.append('title', document.getElementById('titleInput').value);
    formData.append('duration', Math.floor((Date.now() - startTime) / 1000));
    
    const meetingId = document.getElementById('meetingId');
    if (meetingId) {
        formData.append('meeting_id', meetingId.value);
    }

    try {
        const response = await fetch('{{ path('app_recording_upload') }}', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        
        if (result.success) {
            status.textContent = 'Enregistrement sauvegardÃ©!';
            console.log('ðŸ’¾ SauvegardÃ©:', result.recording_id);
            
            setTimeout(() => {
                window.location.href = '{{ path('app_recording_index') }}';
            }, 1500);
        } else {
            throw new Error(result.message || 'Erreur de sauvegarde');
        }
    } catch (error) {
        console.error('âŒ Erreur sauvegarde:', error);
        status.textContent = 'Erreur lors de la sauvegarde';
        saveBtn.disabled = false;
        alert('Erreur lors de la sauvegarde de l\'enregistrement:\n' + error.message);
    }
};

// Initialize on load
window.addEventListener('load', () => {
    console.log('ðŸš€ Page chargÃ©e, initialisation...');
    initMedia();
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (stream) {
        stream.getTracks().forEach(track => {
            track.stop();
            console.log('ðŸ›‘ Track arrÃªtÃ©:', track.kind);
        });
    }
});

console.log('ðŸŽ‰ Interface d\'enregistrement prÃªte!');
</script>
{% endblock %}
