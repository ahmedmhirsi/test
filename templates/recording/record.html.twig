{% extends 'layout/employe.html.twig' %}

{% block title %}Studio d'Enregistrement - SmartNexus AI{% endblock %}

{% block breadcrumb %}
    <span class="text-[#9ca3af] material-symbols-outlined text-[16px]">chevron_right</span>
    <a href="{{ path('app_recording_index') }}" class="text-[#A79E9C] dark:text-[#9ca3af] hover:text-primary font-medium tracking-tight">Archives Vid√©o</a>
    <span class="text-[#9ca3af] material-symbols-outlined text-[16px]">chevron_right</span>
    <span class="text-primary font-semibold tracking-tight">Nouveau Studio</span>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-8">
    
    <!-- Controls Console -->
    <div class="bg-white dark:bg-[#1a1d2d] rounded-3xl border border-[#e5e7eb] dark:border-[#1f2128] shadow-xl overflow-hidden">
        <div class="p-6 md:p-8 flex flex-col md:flex-row items-center justify-between gap-6 border-b border-gray-100 dark:border-[#1f2128]">
            <div class="flex items-center gap-5 w-full md:w-auto">
                <div class="w-14 h-14 rounded-2xl bg-[#eaefff] dark:bg-[#161516] flex items-center justify-center text-primary relative shadow-inner">
                    <span class="material-symbols-outlined text-3xl">videocam</span>
                    <span id="recordingPulse" class="hidden absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-white dark:border-[#1a1d2d] animate-pulse"></span>
                </div>
                <div>
                    <h1 class="text-2xl font-black text-navy dark:text-white tracking-tight leading-tight font-display uppercase italic text-shadow-sm">Capture Interactive</h1>
                    <p class="text-xs font-black text-[#A79E9C] dark:text-[#9ca3af] uppercase tracking-[0.2em] mt-0.5" id="status">Statut : Pr√™t pour initiation</p>
                </div>
            </div>

            <div class="flex flex-wrap items-center gap-3 w-full md:w-auto">
                <button id="startBtn" class="flex-1 md:flex-none h-14 px-8 bg-red-600 text-white rounded-2xl text-xs font-black uppercase tracking-widest hover:brightness-110 flex items-center justify-center gap-3 shadow-lg shadow-red-200 transition-all border-none group">
                    <span class="material-symbols-outlined text-[24px] group-hover:scale-110 transition-transform">fiber_manual_record</span>
                    Lancer l'Enregistrement
                </button>
                <button id="stopBtn" class="flex-1 md:flex-none h-14 px-8 bg-[#f0f0f5] dark:bg-[#161516] text-[#A79E9C] dark:text-[#9ca3af] rounded-2xl text-xs font-black uppercase tracking-widest cursor-not-allowed flex items-center justify-center gap-3 transition-all border-none" disabled>
                    <span class="material-symbols-outlined text-[24px]">stop</span>
                    Interrompre
                </button>
                <button id="saveBtn" class="flex-1 md:flex-none h-14 px-8 bg-gold text-navy rounded-2xl text-xs font-black uppercase tracking-widest hover:brightness-110 hidden flex items-center justify-center gap-3 shadow-lg shadow-gold/20 transition-all border-none group">
                    <span class="material-symbols-outlined text-[24px] group-hover:rotate-12 transition-transform">cloud_upload</span>
                    Finaliser & Cloud Sync
                </button>
            </div>
        </div>

        <div class="p-8 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#f8f8f5]/50 dark:bg-[#0f1115]/50">
            <!-- Video Studio Area -->
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-black rounded-3xl overflow-hidden shadow-2xl relative border-4 border-white dark:border-[#1a1d2d]">
                    <div class="aspect-video relative bg-[#0a0a0c] flex items-center justify-center">
                        <video id="preview" autoplay muted class="w-full h-full object-cover"></video>
                        
                        <!-- HUD Overlays -->
                        <div id="recordingIndicator" class="hidden absolute top-6 left-6 flex items-center gap-4 bg-black/60 backdrop-blur-md px-5 py-2.5 rounded-2xl border border-white/10">
                            <div class="flex items-center gap-2">
                                <span class="w-2.5 h-2.5 bg-red-600 rounded-full animate-pulse shadow-[0_0_10px_rgba(220,38,38,0.8)]"></span>
                                <span class="text-xs font-black text-white uppercase tracking-widest italic pt-0.5">REC</span>
                            </div>
                            <div class="w-px h-4 bg-white/20"></div>
                            <span class="text-sm font-black text-white font-mono tracking-widest pt-0.5" id="timer">00:00</span>
                        </div>
                        
                        <!-- Studio Placeholder -->
                        <div id="studioPlaceholder" class="absolute inset-0 flex flex-col items-center justify-center p-8 text-center bg-navy/20 dark:bg-black/40">
                            <div class="w-20 h-20 rounded-full bg-white/5 backdrop-blur-sm flex items-center justify-center mb-6">
                                <span class="material-symbols-outlined text-white/30 text-5xl animate-pulse">sensors</span>
                            </div>
                            <p class="text-white/50 text-sm font-bold uppercase tracking-[0.3em]">Initialisation du flux num√©rique...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration Sidebar -->
            <div class="space-y-6">
                <div class="bg-white dark:bg-[#1a1d2d] rounded-2xl border border-[#e5e7eb] dark:border-[#1f2128] p-6 shadow-sm">
                    <h2 class="text-[10px] font-black text-[#A79E9C] dark:text-[#9ca3af] uppercase tracking-[0.2em] mb-6 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary text-[18px]">settings_input_component</span>
                        M√©tadonn√©es Session
                    </h2>
                    
                    <div class="space-y-5">
                        <div class="space-y-2">
                            <label class="block text-[10px] font-black text-[#D3C3B9] dark:text-white uppercase tracking-widest pl-1">Identifiant Archive</label>
                            <input type="text" id="titleInput" 
                                class="w-full px-5 py-3.5 bg-[#f8f8f5] dark:bg-[#0f1115] border border-[#e5e7eb] dark:border-[#1f2128] rounded-xl text-sm font-bold focus:ring-2 focus:ring-primary outline-none transition-all text-[#D3C3B9] dark:text-white placeholder:font-medium" 
                                placeholder="Titre de la capture" 
                                value="nexus_archive_{{ 'now'|date('dmy_Hi') }}">
                        </div>

                        {% if meeting %}
                            <div class="p-4 bg-primary/5 rounded-2xl border border-primary/10 space-y-2">
                                <p class="text-[9px] font-black text-primary uppercase tracking-widest">Contexte Collaboration</p>
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-lg bg-white dark:bg-[#1a1d2d] flex items-center justify-center text-navy dark:text-white shadow-sm">
                                        <span class="material-symbols-outlined text-lg">event</span>
                                    </div>
                                    <span class="text-xs font-black text-navy dark:text-white line-clamp-1">{{ meeting.titre }}</span>
                                </div>
                            </div>
                            <input type="hidden" id="meetingId" value="{{ meeting.id }}">
                        {% endif %}
                    </div>
                </div>

                <div class="bg-gradient-to-br from-navy to-[#1a1d2d] rounded-2xl p-6 text-white overflow-hidden relative group">
                    <div class="absolute -right-4 -bottom-4 opacity-5 group-hover:scale-110 transition-transform duration-700">
                        <span class="material-symbols-outlined text-9xl">mic_external_on</span>
                    </div>
                    <h4 class="text-xs font-black uppercase tracking-[0.2em] text-primary mb-3 italic">Optimisation Audio AI</h4>
                    <p class="text-[11px] text-white/60 font-medium leading-relaxed">
                        Le flux audio est automatiquement filtr√© par nos algorithmes pour √©liminer les bruits de fond et isoler les voix humaines.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
}
.animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}
</style>

<script>
console.log('üé• Studio SmartNexus Initialis√©...');

let mediaRecorder;
let recordedChunks = [];
let stream;
let startTime;
let timerInterval;

const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const saveBtn = document.getElementById('saveBtn');
const preview = document.getElementById('preview');
const status = document.getElementById('status');
const recordingIndicator = document.getElementById('recordingIndicator');
const recordingPulse = document.getElementById('recordingPulse');
const timer = document.getElementById('timer');
const studioPlaceholder = document.getElementById('studioPlaceholder');

// initMedia call
async function initMedia() {
    try {
        studioPlaceholder.classList.remove('hidden');
        stream = await navigator.mediaDevices.getUserMedia({
            video: { width: { ideal: 1280 }, height: { ideal: 720 } },
            audio: { echoCancellation: true, noiseSuppression: true }
        });
        
        preview.srcObject = stream;
        studioPlaceholder.classList.add('hidden');
        status.textContent = 'En ligne : Capture pr√™te';
        startBtn.disabled = false;
        return true;
    } catch (error) {
        status.textContent = 'Erreur Mat√©rielle : ' + error.message;
        studioPlaceholder.innerHTML = `<span class="material-symbols-outlined text-red-500 text-5xl mb-4">videocam_off</span><p class="text-red-500/80 text-xs font-black uppercase">Acc√®s cam√©ra/micro refus√©</p>`;
        return false;
    }
}

startBtn.onclick = async () => {
    if (!stream) await initMedia();
    if (!stream) return;

    recordedChunks = [];
    const mimeType = MediaRecorder.isTypeSupported('video/webm;codecs=vp9,opus') ? 'video/webm;codecs=vp9,opus' : 'video/webm';
    
    mediaRecorder = new MediaRecorder(stream, { mimeType });
    mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
    mediaRecorder.onstop = () => {
        clearInterval(timerInterval);
        saveBtn.classList.remove('hidden');
        status.textContent = 'Session captur√©e : En attente de synchronisation';
    };

    mediaRecorder.start(1000);
    startTime = Date.now();
    startBtn.disabled = true;
    startBtn.classList.add('opacity-50', 'pointer-events-none');
    stopBtn.disabled = false;
    stopBtn.classList.remove('cursor-not-allowed', 'text-[#A79E9C]');
    stopBtn.classList.add('bg-white', 'text-navy', 'hover:bg-red-50');
    
    recordingIndicator.classList.remove('hidden');
    recordingPulse.classList.remove('hidden');
    status.textContent = 'Capture en temps r√©el...';
    
    timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const m = Math.floor(elapsed / 60);
        const s = elapsed % 60;
        timer.textContent = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }, 1000);
};

stopBtn.onclick = () => {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        startBtn.disabled = false;
        startBtn.classList.remove('opacity-50', 'pointer-events-none');
        stopBtn.disabled = true;
        recordingIndicator.classList.add('hidden');
        recordingPulse.classList.add('hidden');
    }
};

saveBtn.onclick = async () => {
    if (recordedChunks.length === 0) return;
    status.textContent = 'Synchronisation avec le Cloud SmartNexus...';
    saveBtn.disabled = true;
    saveBtn.classList.add('opacity-50');

    const blob = new Blob(recordedChunks, { type: 'video/webm' });
    const formData = new FormData();
    formData.append('recording', blob, 'nexus_capture.webm');
    formData.append('title', document.getElementById('titleInput').value);
    formData.append('duration', Math.floor((Date.now() - startTime) / 1000));
    
    const meetingId = document.getElementById('meetingId');
    if (meetingId) formData.append('meeting_id', meetingId.value);

    try {
        const response = await fetch('{{ path('app_recording_upload') }}', { method: 'POST', body: formData });
        const result = await response.json();
        if (result.success) {
            status.textContent = 'Synchronisation termin√©e avec succ√®s !';
            setTimeout(() => window.location.href = '{{ path('app_recording_index') }}', 1000);
        } else throw new Error(result.message);
    } catch (error) {
        status.textContent = 'Erreur de synchronisation : ' + error.message;
        saveBtn.disabled = false;
        saveBtn.classList.remove('opacity-50');
    }
};

window.addEventListener('load', initMedia);
window.addEventListener('beforeunload', () => { if (stream) stream.getTracks().forEach(t => t.stop()); });
</script>
{% endblock %}
