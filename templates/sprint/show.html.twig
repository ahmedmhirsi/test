{% extends 'back_office/base.html.twig' %}
{% import '_components.html.twig' as ui %}

{% block title %}Sprint: {{ sprint.nom }} – Performance Intel{% endblock %}

{% block header_title %}
    <span class="flex items-center gap-2">
        <span class="material-symbols-outlined text-nexus-primary">timer</span>
        Sprint Performance Analysis
    </span>
{% endblock %}

{% block content %}
<div class="swup-transition-fade pb-20">

    {# ─── Breadcrumb ─── #}
    <nav class="flex items-center gap-2 text-[11px] font-bold uppercase tracking-wider text-slate-500 mb-8 animate-card">
        <a href="{{ path('app_sprint_index') }}" class="hover:text-nexus-primary transition-colors">Operations</a>
        <span class="material-symbols-outlined text-[16px]">chevron_right</span>
        <span class="text-white">{{ sprint.nom }}</span>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        
        {# ─── Main Content (Sprints & Tasks) ─── #}
        <div class="lg:col-span-3 space-y-8 animate-card" style="animation-delay: 0.1s">
            
            {# Sprint Overview Card #}
            <div class="glass-panel p-8 group">
                <div class="flex flex-col md:flex-row justify-between items-start gap-6 relative z-10 mb-8">
                    <div class="flex items-center gap-4">
                        {% set isActive = sprint.statut|lower in ['actif', 'active', 'en_cours', 'en cours'] %}
                        <div class="size-16 rounded-2xl bg-slate-900 border border-white/5 flex items-center justify-center relative shadow-xl">
                             <span class="material-symbols-outlined text-[32px] {{ isActive ? 'text-nexus-primary' : 'text-slate-500' }}">
                                {{ isActive ? 'bolt' : 'history' }}
                             </span>
                        </div>
                        <div>
                            <div class="flex items-center gap-3">
                                <h1 class="text-4xl font-extrabold text-white tracking-tight">{{ sprint.nom }}</h1>
                                {{ ui.status_badge(sprint.statut) }}
                            </div>
                            <p class="text-slate-500 text-[11px] font-bold uppercase tracking-widest mt-1">
                                {{ sprint.dateDebut|date('d M') }} — {{ sprint.dateFin|date('d M Y') }}
                            </p>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <a href="{{ path('app_sprint_edit', {id: sprint.id}) }}" class="bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-700 px-4 py-2 rounded-xl text-xs font-bold transition-all">
                             <span class="material-symbols-outlined text-[18px] align-middle mr-1">edit</span>
                             Configure
                        </a>
                    </div>
                </div>

                {# Velocity Metrics #}
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 relative z-10">
                    <div class="bg-slate-950/30 p-5 rounded-2xl border border-white/5">
                        <p class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-1">Target Velocity</p>
                        <p class="text-3xl font-black text-white">{{ sprint.objectifVelocite|default(0) }} <span class="text-xs text-slate-600">PTS</span></p>
                    </div>
                    <div class="bg-slate-950/30 p-5 rounded-2xl border border-white/5">
                        <p class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-1">Actual Velocity</p>
                        <p class="text-3xl font-black text-nexus-primary">{{ sprint.velociteReelle|default(0) }} <span class="text-xs text-slate-600">PTS</span></p>
                    </div>
                    <div class="bg-slate-950/30 p-5 rounded-2xl border border-white/5 overflow-hidden relative group/prog">
                        <p class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-1">Completion Ratio</p>
                        {% set velocityPct = sprint.objectifVelocite > 0 ? (sprint.velociteReelle / sprint.objectifVelocite * 100) : 0 %}
                        <p class="text-3xl font-black text-white">{{ velocityPct|round }} <span class="text-xs text-slate-600">%</span></p>
                        <div class="absolute bottom-0 left-0 h-1 bg-slate-800 w-full">
                            <div class="h-full bg-nexus-primary transition-all duration-500" style="width: {{ min(velocityPct, 100) }}%"></div>
                        </div>
                    </div>
                </div>
            </div>

            {# Tasks List #}
            <div>
                 <div class="flex items-center justify-between mb-6 px-4">
                     <h3 class="text-sm font-bold text-white uppercase tracking-widest flex items-center gap-3">
                        <span class="size-2 rounded-full bg-nexus-primary"></span>
                        Sprint Backlog
                    </h3>
                    {% if can_create_tache %}
                    <a href="{{ path('app_tache_new') }}" class="btn-nexus-primary py-1.5 text-xs">
                        <span class="material-symbols-outlined text-[18px]">add_task</span>
                        New Task
                    </a>
                    {% endif %}
                </div>

                <div class="glass-panel overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-950/30 border-b border-white/5 text-[11px] font-bold text-slate-500 uppercase tracking-wider">
                                <tr>
                                    <th class="py-4 px-8">Task Designation</th>
                                    <th class="py-4 px-6 text-center">Priority</th>
                                    <th class="py-4 px-6 text-center">Status</th>
                                    <th class="py-4 px-6 text-center">Allocation</th>
                                    <th class="py-4 px-8 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5">
                                {% for tache in sprint.taches %}
                                    <tr class="group hover:bg-white/[0.02] transition-colors">
                                        <td class="py-5 px-8">
                                            <a href="{{ path('app_tache_show', {id: tache.id}) }}" class="block">
                                                <p class="font-bold text-white group-hover:text-nexus-primary transition-colors line-clamp-1">{{ tache.titre }}</p>
                                                <p class="text-[10px] text-slate-500 font-medium truncate max-w-xs">{{ tache.description|striptags }}</p>
                                            </a>
                                        </td>
                                        <td class="py-5 px-6 text-center text-[10px] font-bold">
                                             {{ ui.priority_badge(tache.priorite) }}
                                        </td>
                                        <td class="py-5 px-6 text-center text-[10px] font-bold">
                                             {{ ui.status_badge(tache.statut) }}
                                        </td>
                                        <td class="py-5 px-6 text-center">
                                             <div class="flex flex-col items-center gap-0.5">
                                                <span class="text-xs font-bold text-white">{{ tache.estimatedHours|default(0) }} <span class="text-[10px] text-slate-600 uppercase">EST</span></span>
                                                {% if tache.loggedHours %}
                                                    <span class="text-[9px] font-bold text-nexus-primary uppercase">{{ tache.loggedHours }} LOG</span>
                                                {% endif %}
                                             </div>
                                        </td>
                                        <td class="py-5 px-8 text-right">
                                             <a href="{{ path('app_tache_show', {id: tache.id}) }}" class="size-8 rounded-lg flex items-center justify-center text-slate-500 hover:text-white hover:bg-slate-800 transition-colors ml-auto">
                                                <span class="material-symbols-outlined text-[18px]">open_in_new</span>
                                            </a>
                                        </td>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td colspan="5" class="py-12 text-center text-slate-600">
                                            <span class="material-symbols-outlined text-[48px] block mb-2 opacity-20">inventory_2</span>
                                            <p class="text-sm font-bold">Backlog registry empty.</p>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        {# ─── Right Sidebar: Metadata ─── #}
        <div class="space-y-6 animate-card" style="animation-delay: 0.2s">
            
            {# Project Context #}
            {% if sprint.projet %}
            <div class="glass-panel p-6 group cursor-pointer" onclick="window.location.href='{{ path('app_projet_show', {id: sprint.projet.id}) }}'">
                <h3 class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-4">Core Portfolio</h3>
                <div class="flex items-center gap-4">
                    <div class="size-10 rounded-xl bg-slate-800 border border-white/5 flex items-center justify-center text-nexus-primary transition-all">
                        <span class="material-symbols-outlined text-[20px]">folder</span>
                    </div>
                    <div>
                        <p class="text-sm font-bold text-white group-hover:text-nexus-primary transition-colors">{{ sprint.projet.titre }}</p>
                        <p class="text-[10px] font-bold text-slate-500 uppercase">Primary Asset</p>
                    </div>
                </div>
            </div>
            {% endif %}

            {# Performance Insights #}
            <div class="glass-panel p-6">
                <h3 class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-6">Strategic Insights</h3>
                <div class="space-y-6">
                    <div class="flex gap-4">
                         <div class="size-8 rounded-lg bg-indigo-500/10 flex items-center justify-center text-indigo-400 shrink-0 border border-indigo-500/20">
                             <span class="material-symbols-outlined text-[18px]">analytics</span>
                         </div>
                         <div>
                             <p class="text-xs font-bold text-white mb-1">Velocity Audit</p>
                             <p class="text-[11px] text-slate-500 leading-relaxed font-medium">
                                 {% if velocityPct < 30 %}
                                     Risk Alert: Progression critical. Immediate tactical adjustment required.
                                 {% elseif velocityPct < 80 %}
                                     Operational: Cycle active. Performance aligns with baseline projections.
                                 {% else %}
                                     Highly Efficient: Objectives nearing completion. Coordinate cycle closure.
                                 {% endif %}
                             </p>
                         </div>
                    </div>
                </div>
            </div>

            {# Actions #}
            <div class="glass-panel p-6 border-rose-500/10 transition-colors hover:border-rose-500/30">
                <h3 class="text-[11px] font-bold text-rose-500/60 uppercase tracking-wider mb-6">Danger Zone</h3>
                <div class="space-y-3">
                     <form method="post" action="{{ path('app_sprint_delete', {id: sprint.id}) }}" onsubmit="return confirm('Archive this sprint cycle?');">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ sprint.id) }}">
                        <button type="submit" class="w-full flex items-center justify-center gap-2 py-3 rounded-xl text-xs font-bold bg-rose-500/10 text-rose-500 border border-rose-500/20 hover:bg-rose-500 hover:text-white transition-all">
                             <span class="material-symbols-outlined text-[18px]">archive</span>
                             Archive Cycle
                        </button>
                    </form>
                </div>
            </div>

            <a href="{{ path('app_sprint_index') }}" class="w-full flex items-center justify-center gap-2 py-3 text-xs font-bold text-slate-500 hover:text-white transition-colors">
                <span class="material-symbols-outlined text-[18px]">arrow_back</span>
                Back to Registry
            </a>
        </div>
    </div>
</div>
{% endblock %}
