{% extends 'back_office/base.html.twig' %}
{% import '_components.html.twig' as ui %}

{% block title %}Tâches - Antigravity Project{% endblock %}

{% block header_title %}
    <span class="flex items-center gap-2">
        <span class="material-symbols-outlined text-nexus-secondary animate-pulse-slow">task_alt</span>
        Mission Control
    </span>
{% endblock %}

{% block content %}
<div class="swup-transition-fade pb-20">

    {# ─── Header ─── #}
    <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
        <div>
            <h1 class="text-4xl font-black text-white tracking-tight leading-tight animate-slide-up">
                Tâches <span class="text-transparent bg-clip-text bg-gradient-to-r from-nexus-secondary to-blue-400">Opérationnelles</span>
            </h1>
            <p class="text-gray-400 text-sm mt-2 animate-slide-up" style="animation-delay: 0.1s">
                Suivi précis de l'exécution et de la performance.
            </p>
        </div>
        
        <div class="flex gap-3 animate-slide-up" style="animation-delay: 0.2s">
            <a href="{{ path('app_tache_export_pdf') }}" class="glass-panel px-4 py-2 flex items-center gap-2 rounded-full hover:bg-white/10 transition-colors group">
                <span class="material-symbols-outlined text-red-400 group-hover:scale-110 transition-transform">picture_as_pdf</span>
                <span class="text-xs font-bold text-gray-300 uppercase tracking-wider">Rapport</span>
            </a>
            {% if can_create_tache %}
            <a href="{{ path('app_tache_new') }}" class="btn-nexus-primary rounded-full px-6 py-2 flex items-center gap-2 shadow-lg shadow-nexus-primary/30 group">
                <span class="material-symbols-outlined text-lg group-hover:rotate-90 transition-transform">add</span>
                <span>Nouvelle Tâche</span>
            </a>
            {% endif %}
        </div>
    </div>

    {# ─── Controls & Stats ─── #}
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8 animate-slide-up" style="animation-delay: 0.3s">
        {# Search #}
        <div class="lg:col-span-2 glass-panel p-1 flex items-center rounded-full antigravity-shadow">
            <form method="get" action="{{ path('app_tache_index') }}" class="flex-1 flex items-center">
                <div class="pl-4 pr-2 text-gray-500">
                    <span class="material-symbols-outlined">search</span>
                </div>
                <input type="text" name="q" value="{{ searchTerm }}" placeholder="Rechercher une tâche par ID, titre..." 
                       class="w-full bg-transparent border-none text-white focus:ring-0 text-sm placeholder-gray-600">
                <input type="hidden" name="sort" value="{{ currentSort }}">
                <input type="hidden" name="order" value="{{ currentOrder }}">
            </form>
        </div>

        {# Sort Dropdown #}
        <div class="relative group z-20">
            <button class="glass-panel w-full px-4 py-3 rounded-full flex items-center justify-between text-sm font-bold text-gray-300 hover:text-white transition-colors">
                <span class="flex items-center gap-2"><span class="material-symbols-outlined text-nexus-accent">sort</span> Trier par</span>
                <span class="material-symbols-outlined text-[16px]">expand_more</span>
            </button>
            <div class="absolute right-0 top-full mt-2 w-full glass-panel p-2 rounded-xl border border-white/10 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all transform translate-y-2 group-hover:translate-y-0">
                <a href="{{ path('app_tache_index', {q: searchTerm, sort: 'priorite', order: 'DESC'}) }}" class="block px-3 py-2 rounded-lg text-xs font-bold text-gray-400 hover:text-white hover:bg-white/10 transition-colors">Priorité</a>
                <a href="{{ path('app_tache_index', {q: searchTerm, sort: 'statut', order: 'ASC'}) }}" class="block px-3 py-2 rounded-lg text-xs font-bold text-gray-400 hover:text-white hover:bg-white/10 transition-colors">Statut</a>
                <a href="{{ path('app_tache_index', {q: searchTerm, sort: 'tempsEstime', order: 'DESC'}) }}" class="block px-3 py-2 rounded-lg text-xs font-bold text-gray-400 hover:text-white hover:bg-white/10 transition-colors">Estimation</a>
            </div>
        </div>

        {# Total Count Badge #}
        <div class="glass-panel flex items-center justify-center gap-3 rounded-full">
            <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Total Active</span>
            <span class="text-xl font-black text-white">{{ taches|length }}</span>
        </div>
    </div>

    {# ─── Glass List (Antigravity Style) ─── #}
    <div class="space-y-3 animate-slide-up" style="animation-delay: 0.4s">
        {% for tache in taches %}
            <div class="glass-panel p-0 group hover:translate-x-1 hover:bg-white/5 transition-all duration-300 relative overflow-hidden">
                {# Status Progress Bar (Visual Flair) #}
                <div class="absolute left-0 top-0 bottom-0 w-1 
                    {% if tache.statut == 'Terminé' %}bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]
                    {% elseif tache.statut == 'En cours' %}bg-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.5)]
                    {% elseif tache.priorite == 'Critique' %}bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]
                    {% else %}bg-gray-600{% endif %}">
                </div>

                <div class="flex flex-col md:flex-row items-center p-4 gap-4 md:gap-8">
                    
                    {# ID & Title #}
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-3 mb-1">
                            <span class="text-[10px] font-black tracking-widest text-gray-600 font-mono group-hover:text-nexus-accent transition-colors">SN-{{ tache.id }}</span>
                            {% if tache.sprint %}
                                <span class="px-2 py-0.5 rounded text-[10px] bg-white/5 text-gray-400 border border-white/5">{{ tache.sprint.nom }}</span>
                            {% endif %}
                        </div>
                        <a href="{{ path('app_tache_show', {id: tache.id}) }}" class="text-lg font-bold text-white group-hover:text-transparent group-hover:bg-clip-text group-hover:bg-gradient-to-r group-hover:from-white group-hover:to-gray-400 transition-all truncate block">
                            {{ tache.titre }}
                        </a>
                    </div>

                    {# Meta Data #}
                    <div class="flex items-center gap-6">
                         {# Assignee #}
                        <div class="hidden md:flex items-center gap-2" title="Assigné à">
                            {% if tache.assignee %}
                                <div class="size-8 rounded-full bg-nexus-navy border border-white/10 flex items-center justify-center text-xs font-bold text-white relative">
                                    {{ tache.assignee.id|user_display_name|slice(0, 2)|upper }}
                                    <span class="absolute bottom-0 right-0 size-2 bg-green-500 rounded-full border border-nexus-navy"></span>
                                </div>
                            {% else %}
                                <div class="size-8 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-gray-500">
                                    <span class="material-symbols-outlined text-[16px]">person_off</span>
                                </div>
                            {% endif %}
                        </div>

                        {# Priority #}
                        <div class="w-24 text-center">
                            {{ ui.priority_badge(tache.priorite) }}
                        </div>

                         {# Status #}
                        <div class="w-24 text-center">
                            {{ ui.status_badge(tache.statut) }}
                        </div>

                        {# Estimation #}
                        <div class="flex flex-col items-end w-16">
                            <span class="text-sm font-black text-white">{{ tache.tempsEstime }}<span class="text-[10px] text-gray-500 font-normal ml-0.5">pts</span></span>
                        </div>
                    </div>

                    {# Actions (Hover Reveal) #}
                    <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity translate-x-4 group-hover:translate-x-0 duration-300">
                         <a href="{{ path('app_tache_show', {id: tache.id}) }}" class="size-8 rounded-lg bg-white/5 flex items-center justify-center text-gray-400 hover:bg-nexus-primary hover:text-white transition-all">
                            <span class="material-symbols-outlined text-[18px]">visibility</span>
                        </a>
                        {% if can_edit_tache %}
                        <a href="{{ path('app_tache_edit', {id: tache.id}) }}" class="size-8 rounded-lg bg-white/5 flex items-center justify-center text-gray-400 hover:bg-nexus-accent hover:text-white transition-all">
                            <span class="material-symbols-outlined text-[18px]">edit</span>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% else %}
            <div class="glass-panel p-16 text-center flex flex-col items-center justify-center">
                <div class="size-20 rounded-full bg-white/5 flex items-center justify-center mb-6">
                    <span class="material-symbols-outlined text-4xl text-gray-600">task_alt</span>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Aucune Tâche Trouvée</h3>
                <p class="text-gray-400 max-w-md mx-auto mb-6">Le système est en attente de nouvelles directives opérationnelles.</p>
                {% if can_create_tache %}
                <a href="{{ path('app_tache_new') }}" class="btn-nexus-primary rounded-full px-8 py-3">
                    Initialiser Tâche
                </a>
                {% endif %}
            </div>
        {% endfor %}
    </div>

</div>
{% endblock %}
