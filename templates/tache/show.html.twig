{% extends 'back_office/base.html.twig' %}
{% import '_components.html.twig' as ui %}

{% block title %}{{ tache.titre }} – Portfolio Overview{% endblock %}

{% block header_title %}
    <span class="flex items-center gap-2">
        <span class="material-symbols-outlined text-nexus-primary">task_alt</span>
        Task Intelligence Hub
    </span>
{% endblock %}

{% block content %}
<div class="swup-transition-fade pb-20">

    {# ─── Breadcrumb ─── #}
    <nav class="flex items-center gap-2 text-[11px] font-bold uppercase tracking-wider text-slate-500 mb-8 animate-card">
        <a href="{{ path('app_tache_index') }}" class="hover:text-nexus-primary transition-colors">Operations</a>
        <span class="material-symbols-outlined text-[16px]">chevron_right</span>
        <span class="text-white">{{ tache.titre }}</span>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {# ─── Left Column: Task Core ─── #}
        <div class="lg:col-span-2 space-y-8 animate-card" style="animation-delay: 0.1s">
            
            {# Task Header Card #}
            <div class="glass-panel p-8 group">
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <div class="flex items-center gap-3 mb-4">
                            {% if tache.statut == 'terminé' %}
                                <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">Completed</span>
                            {% elseif tache.statut == 'en cours' %}
                                <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-nexus-primary/10 text-nexus-primary border border-nexus-primary/20">Active Task</span>
                            {% else %}
                                <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-slate-800 text-slate-400 border border-white/5">Pending Analysis</span>
                            {% endif %}
                            
                             <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest border border-white/5
                                {% if tache.priorite == 'haute' %}bg-rose-500/10 text-rose-400
                                {% elseif tache.priorite == 'moyenne' %}bg-amber-500/10 text-amber-400
                                {% else %}bg-indigo-500/10 text-indigo-400{% endif %}">
                                Priority {{ tache.priorite|capitalize }}
                            </span>
                        </div>
                        <h1 class="text-4xl font-extrabold text-white tracking-tight leading-tight mb-6">{{ tache.titre }}</h1>
                    </div>
                    
                    <div class="flex gap-2">
                        <a href="{{ path('app_tache_edit', {id: tache.id}) }}" class="size-10 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white flex items-center justify-center transition-all border border-slate-700">
                            <span class="material-symbols-outlined text-[20px]">edit</span>
                        </a>
                    </div>
                </div>

                <div class="relative z-10 mt-2">
                    <h3 class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-4">Task Objectives</h3>
                    <div class="p-6 rounded-2xl bg-slate-900/50 border border-white/5 text-slate-300 text-sm leading-relaxed font-medium">
                        {{ tache.description|nl2br }}
                    </div>
                </div>
            </div>

            {# Time & Performance Section #}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div class="glass-panel p-6">
                    <h3 class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-6">Time Analytics</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-950/30 p-4 rounded-2xl border border-white/5">
                            <p class="text-[10px] font-bold text-slate-500 uppercase mb-1">Estimated</p>
                            <p class="text-2xl font-black text-white">{{ tache.estimatedHours|default(0) }} <span class="text-xs text-slate-600">H</span></p>
                        </div>
                        <div class="bg-slate-950/30 p-4 rounded-2xl border border-white/5">
                             <p class="text-[10px] font-bold text-slate-500 uppercase mb-1">Logged</p>
                            <p class="text-2xl font-black text-nexus-primary">{{ tache.loggedHours|default(0) }} <span class="text-xs text-slate-600">H</span></p>
                        </div>
                    </div>
                    
                    {% set progress = tache.estimatedHours|default(0) > 0 ? ((tache.loggedHours|default(0)) / tache.estimatedHours * 100)|round : 0 %}
                    <div class="mt-8">
                        <div class="flex justify-between items-end mb-2">
                             <span class="text-[11px] font-bold text-slate-500 uppercase">Velocity Progress</span>
                             <span class="text-xl font-black text-white">{{ progress }}%</span>
                        </div>
                         <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                            <div class="h-full bg-nexus-primary rounded-full transition-all duration-1000" style="width: {{ min(progress, 100) }}%"></div>
                        </div>
                    </div>
                 </div>

                 <div class="glass-panel p-6 flex flex-col justify-between">
                     <h3 class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-4">Assigned Expert</h3>
                     <div class="flex items-center gap-4 bg-slate-950/30 p-4 rounded-2xl border border-white/5 group">
                         {% if tache.assignedTo %}
                            <div class="size-12 rounded-full bg-slate-800 border border-white/10 flex items-center justify-center text-white font-bold text-sm transition-transform group-hover:scale-105">
                                {{ tache.assignedTo.prenom|first|upper }}{{ tache.assignedTo.nom|first|upper }}
                            </div>
                            <div>
                                <p class="text-sm font-bold text-white">{{ tache.assignedTo.prenom }} {{ tache.assignedTo.nom }}</p>
                                <p class="text-[10px] font-bold text-slate-500 uppercase">Consultant</p>
                            </div>
                         {% else %}
                             <div class="size-12 rounded-full bg-slate-800 flex items-center justify-center text-slate-600">
                                <span class="material-symbols-outlined">person_off</span>
                            </div>
                            <p class="text-sm font-bold text-slate-500">Unallocated</p>
                         {% endif %}
                     </div>
                     <div class="mt-6">
                        <a href="{{ path('app_tache_log_time', {id: tache.id}) }}" class="w-full btn-nexus-primary py-3 rounded-xl flex items-center justify-center gap-2 text-xs">
                            <span class="material-symbols-outlined text-[18px]">add_task</span>
                            Log Entry
                        </a>
                     </div>
                 </div>
            </div>
        </div>

        {# ─── Right Column: Context ─── #}
        <div class="space-y-6 animate-card" style="animation-delay: 0.2s">
            
            <div class="glass-panel p-6">
                <h3 class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-6">Task Context</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center bg-slate-950/30 p-3 rounded-xl border border-white/5">
                        <span class="text-[10px] font-bold text-slate-500 uppercase">Initiated</span>
                        <span class="text-xs font-bold text-white">{{ tache.dateCreation|date('d M Y') }}</span>
                    </div>
                    <div class="flex justify-between items-center bg-slate-950/30 p-3 rounded-xl border border-white/5">
                        <span class="text-[10px] font-bold text-slate-500 uppercase">Deadline</span>
                        <span class="text-xs font-bold {% if tache.dateEcheance < date() %}text-rose-500{% else %}text-white{% endif %}">
                            {{ tache.dateEcheance ? tache.dateEcheance|date('d M Y') : 'TBD' }}
                        </span>
                    </div>
                    {% if tache.sprint %}
                    <div class="pt-4 border-t border-white/5">
                        <p class="text-[10px] font-bold text-slate-600 uppercase mb-2">Associated Sprint</p>
                        <a href="{{ path('app_sprint_show', {id: tache.sprint.id}) }}" class="flex items-center gap-3 group">
                            <div class="size-8 rounded-lg bg-slate-800 flex items-center justify-center text-nexus-primary border border-white/5">
                                <span class="material-symbols-outlined text-[18px]">timer</span>
                            </div>
                            <span class="text-sm font-bold text-white group-hover:text-nexus-primary transition-colors">{{ tache.sprint.nom }}</span>
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="glass-panel p-6 border-rose-500/10 transition-colors hover:border-rose-500/30">
                <h3 class="text-[11px] font-bold text-rose-500/60 uppercase tracking-wider mb-6">Danger Zone</h3>
                <form method="post" action="{{ path('app_tache_delete', {id: tache.id}) }}" onsubmit="return confirm('Archive this task permanently?');">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ tache.id) }}">
                    <button type="submit" class="w-full py-3 px-4 rounded-xl text-xs font-bold bg-rose-500/10 text-rose-500 border border-rose-500/20 hover:bg-rose-500 hover:text-white transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">delete</span>
                        Archive Task
                    </button>
                </form>
            </div>
            
             <a href="{{ path('app_tache_index') }}" class="w-full flex items-center justify-center gap-2 py-3 text-xs font-bold text-slate-500 hover:text-white transition-colors">
                <span class="material-symbols-outlined text-[18px]">arrow_back</span>
                Back to Operations
            </a>
        </div>
    </div>
</div>
{% endblock %}
