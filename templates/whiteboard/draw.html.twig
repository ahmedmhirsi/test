{% extends 'layout/employe.html.twig' %}

{% block title %}{{ whiteboard.title }} – Nexus Studio – SmartNexus AI{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        body { margin: 0; overflow: hidden; }

        /* ── Modernized Toolbar ── */
        .wb-toolbar {
            position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%);
            z-index: 100; display: flex; align-items: center; gap: 8px;
            background: rgba(16, 18, 24, 0.85); backdrop-filter: blur(20px);
            padding: 10px 20px; border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            font-family: 'Manrope', system-ui, sans-serif;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .wb-toolbar:hover { border-color: rgba(220, 180, 100, 0.3); }

        .wb-toolbar .sep { width: 1px; height: 32px; background: rgba(255,255,255,0.1); margin: 0 8px; }

        .wb-toolbar button {
            display: flex; align-items: center; justify-content: center;
            width: 44px; height: 44px; border-radius: 14px;
            border: none; background: transparent; cursor: pointer;
            color: rgba(255,255,255,0.6); transition: all 0.2s;
            font-size: 24px; padding: 0;
            position: relative;
        }
        .wb-toolbar button:hover { background: rgba(255,255,255,0.1); color: #fff; transform: translateY(-2px); }
        .wb-toolbar button.active { background: #DCB464; color: #D3C3B9; box-shadow: 0 4px 12px rgba(220, 180, 100, 0.3); }
        .wb-toolbar button.active::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
            width: 4px; height: 4px; border-radius: 50%; background: #DCB464;
        }

        .wb-toolbar button:disabled { opacity: 0.2; cursor: not-allowed; transform: none; }

        /* ── Tools Extra ── */
        .wb-toolbar input[type=color] {
            -webkit-appearance: none; appearance: none; border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px; width: 32px; height: 32px; padding: 0; cursor: pointer;
            background: transparent; overflow: hidden;
        }
        .wb-toolbar input[type=color]::-webkit-color-swatch-wrapper { padding: 0; }
        .wb-toolbar input[type=color]::-webkit-color-swatch { border: none; }

        .wb-toolbar input[type=range] { width: 80px; accent-color: #DCB464; height: 4px; }
        .wb-toolbar .size-label {
            font-size: 10px; font-weight: 800; color: #DCB464; min-width: 28px; text-align: center; font-family: 'Montserrat';
        }

        /* ── Interface Navigation ── */
        .wb-nav {
            position: fixed; top: 24px; left: 24px; z-index: 100;
            display: flex; align-items: center; gap: 12px;
        }
        .wb-nav-btn {
            height: 48px; padding: 0 20px; border-radius: 16px;
            background: rgba(16, 18, 24, 0.85); backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.1); color: #fff;
            text-decoration: none; font-size: 12px; font-weight: 800; text-transform: uppercase;
            letter-spacing: 0.1em; display: flex; align-items: center; gap: 10px;
            transition: all 0.2s; font-family: 'Montserrat';
        }
        .wb-nav-btn:hover { background: #DCB464; color: #D3C3B9; transform: translateX(5px); }

        /* ── Metadata Badge ── */
        .wb-meta {
            position: fixed; top: 24px; right: 24px; z-index: 100;
            padding: 12px 24px; border-radius: 16px;
            background: rgba(16, 18, 24, 0.85); backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.1); color: #fff;
            display: flex; align-items: center; gap: 12px;
            font-family: 'Montserrat';
        }
        .wb-meta h2 { font-size: 13px; font-weight: 900; letter-spacing: 0.05em; text-transform: uppercase; font-style: italic; }
        .wb-meta .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #22c55e; box-shadow: 0 0 10px #22c55e; animation: nexus-pulse 2s infinite; }
        
        @keyframes nexus-pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.4;transform:scale(1.2)} }

        /* ── Toast Notifications ── */
        .wb-toast {
            position: fixed; top: 90px; left: 50%; transform: translateX(-50%) translateY(-20px);
            z-index: 200; padding: 12px 32px; border-radius: 12px;
            background: #DCB464; color: #D3C3B9; font-size: 11px; font-weight: 900;
            text-transform: uppercase; letter-spacing: 0.2em;
            box-shadow: 0 10px 30px rgba(220, 180, 100, 0.3);
            opacity: 0; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); pointer-events: none;
        }
        .wb-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* ── Canvas Layer ── */
        .wb-studio {
            position: absolute; inset: 20px; background: #fff;
            border-radius: 32px; box-shadow: inset 0 0 50px rgba(0,0,0,0.05);
            overflow: hidden; border: 8px solid rgba(16, 18, 24, 0.05);
        }
    </style>
{% endblock %}

{% block breadcrumb %}
    <span class="text-[#9ca3af] material-symbols-outlined text-[16px]">chevron_right</span>
    <a href="{{ path('app_whiteboard_index') }}" class="text-[#A79E9C] dark:text-[#9ca3af] hover:text-primary font-medium">Tableaux Blancs</a>
    <span class="text-[#9ca3af] material-symbols-outlined text-[16px]">chevron_right</span>
    <span class="text-primary font-semibold italic">{{ whiteboard.title }}</span>
{% endblock %}

{% block body %}
    <div class="fixed inset-0 bg-[#f8f8f5] dark:bg-[#0a0a0c] z-[-1]"></div>

    {# ── Navigation ── #}
    <div class="wb-nav">
        <a href="{{ path('app_whiteboard_index') }}" class="wb-nav-btn">
            <span class="material-symbols-outlined">arrow_back</span>
            Archives
        </a>
    </div>

    {# ── Title & Status ── #}
    <div class="wb-meta">
        <div class="status-dot"></div>
        <h2 class="italic tracking-tighter">{{ whiteboard.title }}</h2>
    </div>

    {# ── Studio Canvas ── #}
    <div class="wb-studio">
        <canvas id="whiteboard-canvas"></canvas>
    </div>

    {# ── Interactive Toolbar ── #}
    <div class="wb-toolbar" id="toolbar">
        <button id="tool-select" title="Sélecteur" class="active"><span class="material-symbols-outlined">near_me</span></button>
        <button id="tool-pencil" title="Dessin libre"><span class="material-symbols-outlined">brush</span></button>
        <button id="tool-line" title="Segments"><span class="material-symbols-outlined">horizontal_rule</span></button>
        <button id="tool-rect" title="Rectangle"><span class="material-symbols-outlined">rectangle</span></button>
        <button id="tool-circle" title="Éllipse"><span class="material-symbols-outlined">circle</span></button>
        <button id="tool-text" title="Insertion Texte"><span class="material-symbols-outlined">text_fields_rtl</span></button>
        <button id="tool-eraser" title="Gomme Native"><span class="material-symbols-outlined">auto_fix</span></button>

        <div class="sep"></div>

        <div class="flex items-center gap-3 px-2">
            <input type="color" id="color-picker" value="#DCB464" title="Palette Nexus">
            <div class="flex flex-col items-center">
                <input type="range" id="brush-size" min="1" max="50" value="4">
                <span class="size-label" id="size-label">04</span>
            </div>
        </div>

        <div class="sep"></div>

        <button id="btn-undo" title="Recall Action" disabled><span class="material-symbols-outlined">undo</span></button>
        <button id="btn-redo" title="Repeat Action" disabled><span class="material-symbols-outlined">redo</span></button>
        <button id="btn-clear" title="Reset Canvas" class="hover:text-red-500"><span class="material-symbols-outlined">delete_sweep</span></button>

        <div class="sep"></div>

        <button id="btn-save" title="Nexus Cloud Sync" class="bg-primary/20 text-primary hover:bg-primary hover:text-navy"><span class="material-symbols-outlined">cloud_done</span></button>
        <button id="btn-download" title="Export Ultra-HD (PNG)"><span class="material-symbols-outlined">download</span></button>
    </div>

    {# ── System Feedback ── #}
    <div class="wb-toast" id="toast">Synchronisation Nexus Cloud...</div>
{% endblock %}

{% block importmap %}{% endblock %}

{% block javascripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const ROOM_ID = {{ whiteboard.id }};

        /* ─── Canvas ─── */
        const canvasEl = document.getElementById('whiteboard-canvas');
        canvasEl.width = window.innerWidth;
        canvasEl.height = window.innerHeight;

        const canvas = new fabric.Canvas('whiteboard-canvas', {
            width: window.innerWidth,
            height: window.innerHeight,
            backgroundColor: '#ffffff',
            isDrawingMode: false
        });

        window.addEventListener('resize', () => {
            canvas.setWidth(window.innerWidth);
            canvas.setHeight(window.innerHeight);
            canvas.renderAll();
        });

        /* ─── Undo / Redo ─── */
        let history = [];
        let redoStack = [];
        let ignoreHistory = false;

        function saveState() {
            if (ignoreHistory) return;
            history.push(canvas.toJSON());
            redoStack = [];
            updateUndoRedo();
        }

        function updateUndoRedo() {
            document.getElementById('btn-undo').disabled = history.length <= 0;
            document.getElementById('btn-redo').disabled = redoStack.length <= 0;
        }

        canvas.on('object:added', saveState);
        canvas.on('object:modified', saveState);
        canvas.on('object:removed', saveState);

        document.getElementById('btn-undo').addEventListener('click', () => {
            if (history.length === 0) return;
            redoStack.push(canvas.toJSON());
            const prev = history.pop();
            ignoreHistory = true;
            canvas.loadFromJSON(prev, () => { canvas.renderAll(); ignoreHistory = false; updateUndoRedo(); });
        });
        document.getElementById('btn-redo').addEventListener('click', () => {
            if (redoStack.length === 0) return;
            history.push(canvas.toJSON());
            const next = redoStack.pop();
            ignoreHistory = true;
            canvas.loadFromJSON(next, () => { canvas.renderAll(); ignoreHistory = false; updateUndoRedo(); });
        });

        /* ─── Tools ─── */
        let currentTool = 'select';
        const toolBtns = {
            select: document.getElementById('tool-select'),
            pencil: document.getElementById('tool-pencil'),
            line: document.getElementById('tool-line'),
            rect: document.getElementById('tool-rect'),
            circle: document.getElementById('tool-circle'),
            text: document.getElementById('tool-text'),
            eraser: document.getElementById('tool-eraser'),
        };
        const colorPicker = document.getElementById('color-picker');
        const brushSize = document.getElementById('brush-size');
        const sizeLabel = document.getElementById('size-label');

        function setTool(tool) {
            currentTool = tool;
            Object.values(toolBtns).forEach(b => b.classList.remove('active'));
            toolBtns[tool].classList.add('active');
            canvas.isDrawingMode = (tool === 'pencil' || tool === 'eraser');
            canvas.selection = (tool === 'select');
            if (tool === 'pencil') {
                canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
                canvas.freeDrawingBrush.color = colorPicker.value;
                canvas.freeDrawingBrush.width = parseInt(brushSize.value);
            } else if (tool === 'eraser') {
                canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
                canvas.freeDrawingBrush.color = '#ffffff';
                canvas.freeDrawingBrush.width = parseInt(brushSize.value) * 3;
            }
            if (tool !== 'select') {
                canvas.discardActiveObject();
                canvas.renderAll();
            }
        }

        Object.entries(toolBtns).forEach(([name, btn]) => {
            btn.addEventListener('click', () => setTool(name));
        });

        colorPicker.addEventListener('input', () => {
            if (canvas.isDrawingMode && currentTool === 'pencil') {
                canvas.freeDrawingBrush.color = colorPicker.value;
            }
            // Update active object
            const active = canvas.getActiveObject();
            if (active) {
                if (active.type === 'i-text' || active.type === 'textbox') {
                    active.set('fill', colorPicker.value);
                } else {
                    active.set('stroke', colorPicker.value);
                }
                canvas.renderAll();
            }
        });

        brushSize.addEventListener('input', () => {
            sizeLabel.textContent = brushSize.value;
            if (canvas.isDrawingMode && canvas.freeDrawingBrush) {
                canvas.freeDrawingBrush.width = parseInt(brushSize.value) * (currentTool === 'eraser' ? 3 : 1);
            }
        });

        /* ─── Shape Drawing ─── */
        let isDrawingShape = false;
        let startX, startY, shapeObj;

        canvas.on('mouse:down', (opt) => {
            if (['line', 'rect', 'circle'].includes(currentTool)) {
                isDrawingShape = true;
                const pointer = canvas.getPointer(opt.e);
                startX = pointer.x;
                startY = pointer.y;
                const stroke = colorPicker.value;
                const sw = parseInt(brushSize.value);

                if (currentTool === 'line') {
                    shapeObj = new fabric.Line([startX, startY, startX, startY], {
                        stroke, strokeWidth: sw, selectable: true, evented: true
                    });
                } else if (currentTool === 'rect') {
                    shapeObj = new fabric.Rect({
                        left: startX, top: startY, width: 0, height: 0,
                        fill: 'transparent', stroke, strokeWidth: sw, selectable: true, evented: true
                    });
                } else if (currentTool === 'circle') {
                    shapeObj = new fabric.Ellipse({
                        left: startX, top: startY, rx: 0, ry: 0,
                        fill: 'transparent', stroke, strokeWidth: sw, selectable: true, evented: true
                    });
                }
                canvas.add(shapeObj);
            }
            if (currentTool === 'text') {
                const pointer = canvas.getPointer(opt.e);
                const text = new fabric.IText('Texte', {
                    left: pointer.x, top: pointer.y,
                    fontFamily: 'Manrope, system-ui, sans-serif',
                    fontSize: parseInt(brushSize.value) * 5 + 10,
                    fill: colorPicker.value,
                    selectable: true, evented: true
                });
                canvas.add(text);
                canvas.setActiveObject(text);
                text.enterEditing();
                setTool('select');
            }
        });

        canvas.on('mouse:move', (opt) => {
            if (!isDrawingShape || !shapeObj) return;
            const pointer = canvas.getPointer(opt.e);
            if (currentTool === 'line') {
                shapeObj.set({ x2: pointer.x, y2: pointer.y });
            } else if (currentTool === 'rect') {
                const w = pointer.x - startX;
                const h = pointer.y - startY;
                shapeObj.set({
                    left: w < 0 ? pointer.x : startX,
                    top: h < 0 ? pointer.y : startY,
                    width: Math.abs(w),
                    height: Math.abs(h)
                });
            } else if (currentTool === 'circle') {
                shapeObj.set({
                    rx: Math.abs(pointer.x - startX) / 2,
                    ry: Math.abs(pointer.y - startY) / 2,
                    left: Math.min(startX, pointer.x),
                    top: Math.min(startY, pointer.y)
                });
            }
            canvas.renderAll();
        });

        canvas.on('mouse:up', () => {
            isDrawingShape = false;
            shapeObj = null;
        });

        /* ─── Delete key ─── */
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Delete' || e.key === 'Backspace') {
                const active = canvas.getActiveObject();
                if (active && !(active.isEditing)) {
                    canvas.remove(active);
                    canvas.renderAll();
                }
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                document.getElementById('btn-undo').click();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                e.preventDefault();
                document.getElementById('btn-redo').click();
            }
        });

        /* ─── Clear ─── */
        document.getElementById('btn-clear').addEventListener('click', () => {
            if (confirm('Effacer tout le tableau ?')) {
                canvas.clear();
                canvas.setBackgroundColor('#ffffff', canvas.renderAll.bind(canvas));
            }
        });

        /* ─── Toast ─── */
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        /* ─── Save ─── */
        async function saveCanvas() {
            try {
                const data = JSON.stringify(canvas.toJSON());
                const resp = await fetch(`/collaboration/whiteboard/${ROOM_ID}/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: data
                });
                const result = await resp.json();
                if (result.success) showToast('✓ Sauvegardé');
            } catch (e) { console.error('Save failed', e); showToast('✗ Erreur de sauvegarde'); }
        }

        document.getElementById('btn-save').addEventListener('click', saveCanvas);

        /* ─── Auto-save ─── */
        let autoSaveTimeout;
        canvas.on('object:added', () => { clearTimeout(autoSaveTimeout); autoSaveTimeout = setTimeout(saveCanvas, 2500); });
        canvas.on('object:modified', () => { clearTimeout(autoSaveTimeout); autoSaveTimeout = setTimeout(saveCanvas, 2500); });
        canvas.on('object:removed', () => { clearTimeout(autoSaveTimeout); autoSaveTimeout = setTimeout(saveCanvas, 2500); });

        /* ─── Load ─── */
        async function loadCanvas() {
            try {
                const resp = await fetch(`/collaboration/whiteboard/${ROOM_ID}/load`);
                const result = await resp.json();
                if (result.success && result.canvas_data) {
                    const json = typeof result.canvas_data === 'string' ? JSON.parse(result.canvas_data) : result.canvas_data;
                    ignoreHistory = true;
                    canvas.loadFromJSON(json, () => {
                        canvas.renderAll();
                        ignoreHistory = false;
                        history = [];
                        redoStack = [];
                        updateUndoRedo();
                        showToast('✓ Tableau chargé');
                    });
                }
            } catch (e) { console.error('Load failed', e); }
        }

        loadCanvas();

        /* ─── Download PNG ─── */
        document.getElementById('btn-download').addEventListener('click', () => {
            const dataURL = canvas.toDataURL({ format: 'png', quality: 1 });
            const link = document.createElement('a');
            link.download = `tableau-blanc-${ROOM_ID}.png`;
            link.href = dataURL;
            link.click();
            showToast('✓ Image téléchargée');
        });
    });
    </script>
{% endblock %}
